<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified Message System Test</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="src/ui/unifiedMessageStyles.css">

    <!-- Emergency localStorage cleanup to fix JSON parsing errors -->
    <script src="emergency-cleanup.js"></script>
    <style>
        /* Theme Variables */
        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: #0f0f0f;
            --text-primary: #e0e0e0;
            --text-secondary: #aaa;
            --border-primary: #333;
            --border-secondary: #444;
        }

        /* Dark Theme (Default) */
        .theme-dark {
            --bg-primary: #1a1a1a;
            --bg-secondary: #0f0f0f;
            --text-primary: #e0e0e0;
            --text-secondary: #aaa;
            --border-primary: #333;
            --border-secondary: #444;
        }

        /* Light Theme */
        .theme-light {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-primary: #dee2e6;
            --border-secondary: #ced4da;
        }

        /* Blue Theme */
        .theme-blue {
            --bg-primary: #1e3a8a;
            --bg-secondary: #1e40af;
            --text-primary: #e0e7ff;
            --text-secondary: #c7d2fe;
            --border-primary: #3b82f6;
            --border-secondary: #60a5fa;
        }

        /* Green Theme */
        .theme-green {
            --bg-primary: #064e3b;
            --bg-secondary: #065f46;
            --text-primary: #d1fae5;
            --text-secondary: #a7f3d0;
            --border-primary: #10b981;
            --border-secondary: #34d399;
        }

        /* Purple Theme */
        .theme-purple {
            --bg-primary: #581c87;
            --bg-secondary: #6b21a8;
            --text-primary: #f3e8ff;
            --text-secondary: #e9d5ff;
            --border-primary: #a855f7;
            --border-secondary: #c084fc;
        }

        /* Gray Theme */
        .theme-gray {
            --bg-primary: #374151;
            --bg-secondary: #4b5563;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --border-primary: #6b7280;
            --border-secondary: #9ca3af;
        }

        body {
            margin: 20px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            transition: all 0.3s ease;
            height: calc(100vh - 40px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
        }

        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            background: var(--bg-secondary);
            flex-shrink: 0;
        }

        .test-section.chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-bottom: 0;
            min-height: 0;
        }

        .test-section h2,
        .test-section h3 {
            color: var(--text-primary);
            margin-top: 0;
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        .test-controls {
            margin: 10px 0;
        }

        button {
            margin: 5px;
            padding: 10px 15px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background: #0052a3;
        }

        .container {
            display: flex;
            gap: 20px;
            height: calc(100vh - 120px);
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
            padding: 15px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
        }

        .theme-selector {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 0 15px;
            border-left: 1px solid var(--border-primary);
        }

        .theme-button {
            padding: 6px 12px;
            border: 1px solid var(--border-secondary);
            background: var(--bg-primary);
            color: var(--text-primary);
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .theme-button:hover {
            background: var(--border-primary);
        }

        .theme-button.active {
            background: var(--border-secondary);
            font-weight: bold;
        }

        #chatWindow {
            flex: 1;
            overflow-y: auto;
            border: 1px solid var(--border-primary);
            padding: 10px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.3s ease;
            min-height: 200px;
        }

        .chat-container {
            display: flex;
            gap: 20px;
            margin: 10px 0 0 0;
            align-items: stretch;
            flex: 1;
            min-height: 0;
        }

        .chat-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .chat-panel h3 {
            margin-top: 0;
            margin-bottom: 10px;
            flex-shrink: 0;
        }

        .queue-panel-wrapper {
            width: 450px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .queue-panel-wrapper h3 {
            margin-top: 0;
            margin-bottom: 10px;
            flex-shrink: 0;
        }

        .queue-panel {
            width: 450px;
            flex-shrink: 0;
            border: 1px solid var(--border-primary);
            background: var(--bg-secondary);
            padding: 10px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            min-height: 200px;
            flex: 1;
        }

        .queue-item {
            margin: 5px 0;
            padding: 8px;
            border: 1px solid var(--border-secondary);
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
            text-align: left;
            width: 100%;
            box-sizing: border-box;
        }

        .queue-item.processing {
            border-color: #0066cc;
            background: rgba(0, 102, 204, 0.1);
        }

        .queue-item.completed {
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.1);
        }

        .queue-item.failed {
            border-color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
        }

        .queue-item-header {
            font-weight: bold;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .queue-item-details {
            color: var(--text-secondary);
            line-height: 1.3;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 200px;
            overflow-y: auto;
            text-align: left;
        }

        .queue-item-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            padding: 6px;
            margin-top: 4px;
            border-radius: 3px;
            font-family: inherit;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 200px;
            overflow-y: auto;
            font-size: 11px;
            text-align: left;
            width: 100%;
            box-sizing: border-box;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            background: #333;
        }
    </style>
</head>

<body class="theme-dark">
    <div class="main-content">
        <div class="test-section">
            <h2>System Status</h2>
            <div id="systemStatus" class="status">Initializing...</div>
        </div>

        <div class="controls">
            <div>
                <h3 style="margin: 0; color: var(--text-primary);">Unified Message System Test</h3>
            </div>
            <div class="theme-selector">
                <span style="color: var(--text-secondary);">Theme:</span>
                <button class="theme-button active" onclick="switchTheme('dark')">Dark</button>
                <button class="theme-button" onclick="switchTheme('light')">Light</button>
                <button class="theme-button" onclick="switchTheme('blue')">Blue</button>
                <button class="theme-button" onclick="switchTheme('green')">Green</button>
                <button class="theme-button" onclick="switchTheme('purple')">Purple</button>
                <button class="theme-button" onclick="switchTheme('gray')">Gray</button>
            </div>
        </div>

        <div class="test-section">
            <h2>Test Controls</h2>
            <div class="test-controls">
                <button onclick="testUserMessage()">Test User Message</button>
                <button onclick="testAgentMessage()">Test Agent Message</button>
                <button onclick="testAICompanionMessage()">Test AI Companion Message</button>
                <button onclick="testThinkingMessage()">Test Thinking Message</button>
                <button onclick="testSystemMessage()">Test System Message</button>
                <button onclick="testErrorMessage()">Test Error Message</button>
                <button onclick="clearMessages()">Clear Messages</button>
            </div>
        </div>

        <div class="test-section chat-section">
            <h2>Chat Window & Message Queue</h2>
            <div class="chat-container">
                <div class="chat-panel">
                    <h3>Chat Window</h3>
                    <div id="chatWindow"></div>
                </div>
                <div class="queue-panel-wrapper">
                    <h3>Message Queue Debug</h3>
                    <div id="queuePanel" class="queue-panel">
                        <div style="color: #666;">Waiting for messages...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load required libraries -->
    <script src="lib/marked.min.js"></script>
    <script src="lib/purify.min.js"></script>

    <script>
        // Global theme switching functionality
        function switchTheme(themeName) {
            // Remove all theme classes
            document.body.classList.remove('theme-dark', 'theme-light', 'theme-blue', 'theme-green', 'theme-purple', 'theme-gray');

            // Add the new theme class
            document.body.classList.add(`theme-${themeName}`);

            // Update active button
            document.querySelectorAll('.theme-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Save theme preference
            localStorage.setItem('selectedTheme', themeName);

            // Update status if available
            if (window.updateStatus) {
                window.updateStatus(`Theme switched to: ${themeName.charAt(0).toUpperCase() + themeName.slice(1)}`);
            }
        }

        // Load saved theme on page load
        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('selectedTheme') || 'dark';
            document.body.classList.add(`theme-${savedTheme}`);

            // Update active button
            document.querySelectorAll('.theme-button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.toLowerCase() === savedTheme) {
                    btn.classList.add('active');
                }
            });
        }

        // Load theme immediately
        loadSavedTheme();
    </script>

    <script type="module">
        import { UnifiedMessageRenderer, MessageTypes } from './src/ui/unifiedMessageRenderer.js';
        import { DOMUtils } from './src/utils/domUtils.js';
        import { Icons } from './src/components/svg-icon-manager/index.js';

        let messageRenderer;
        let messageCounter = 0;
        let queueUpdateInterval;
        let processedMessages = []; // Track recently processed messages
        let maxProcessedHistory = 10;

        function updateStatus(message) {
            document.getElementById('systemStatus').textContent = message;
        }

        function updateQueuePanel() {
            const queuePanel = document.getElementById('queuePanel');
            if (!messageRenderer || !queuePanel) return;

            const queue = messageRenderer.messageQueue || [];
            const streamingStates = messageRenderer.streamingStates || new Map();
            const renderingInProgress = messageRenderer.renderingInProgress || new Set();
            const isProcessing = messageRenderer.isProcessingQueue || false;

            let html = '';

            // Show current processing status
            html += `<div style="color: #0066cc; margin-bottom: 10px;">
                <strong>Queue Status:</strong><br>
                • Processing: ${isProcessing ? 'Yes' : 'No'}<br>
                • Queue Length: ${queue.length}<br>
                • Streaming: ${streamingStates.size}<br>
                • Rendering: ${renderingInProgress.size}
            </div>`;

            // Show currently processing
            if (isProcessing) {
                html += '<div class="queue-item processing"><div class="queue-item-header">🔄 Processing Queue</div></div>';
            }

            // Show queued messages
            if (queue.length > 0) {
                queue.forEach((msg, index) => {
                    html += `
                        <div class="queue-item">
                            <div class="queue-item-header">📝 Queued #${index + 1}</div>
                            <div class="queue-item-details">
                                Type: ${msg.type}<br>
                                ID: ${msg.id}<br>
                                Status: ${msg.status}<br>
                                Sender: ${msg.sender || 'N/A'}<br>
                                Timestamp: ${msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString() : 'N/A'}
                                ${msg.content ? `<div class="queue-item-content">${msg.content}</div>` : ''}
                            </div>
                        </div>
                    `;
                });
            }

            // Show streaming messages
            if (streamingStates.size > 0) {
                streamingStates.forEach((state, messageId) => {
                    html += `
                        <div class="queue-item processing">
                            <div class="queue-item-header">📡 Streaming</div>
                            <div class="queue-item-details">
                                ID: ${messageId}<br>
                                Status: Streaming<br>
                                Progress: ${state.progress || 'N/A'}
                                ${state.content ? `<div class="queue-item-content">${state.content}</div>` : ''}
                            </div>
                        </div>
                    `;
                });
            }

            // Show rendering in progress
            if (renderingInProgress.size > 0) {
                renderingInProgress.forEach((messageId) => {
                    // Try to find the message data
                    const renderingMsg = queue.find(msg => msg.id === messageId) ||
                        processedMessages.find(msg => msg.id === messageId);

                    html += `
                        <div class="queue-item processing">
                            <div class="queue-item-header">🎨 Rendering</div>
                            <div class="queue-item-details">
                                ID: ${messageId}<br>
                                Status: Rendering<br>
                                Type: ${renderingMsg?.type || 'Unknown'}
                                ${renderingMsg?.content ? `<div class="queue-item-content">${renderingMsg.content}</div>` : ''}
                            </div>
                        </div>
                    `;
                });
            }

            // Show recently processed messages
            if (processedMessages.length > 0) {
                html += '<div style="color: #28a745; margin: 10px 0;"><strong>Recently Processed:</strong></div>';
                processedMessages.slice(-5).forEach((msg, index) => {
                    html += `
                        <div class="queue-item completed">
                            <div class="queue-item-header">✅ Completed</div>
                            <div class="queue-item-details">
                                Type: ${msg.type}<br>
                                ID: ${msg.id}<br>
                                Sender: ${msg.sender || 'N/A'}<br>
                                Processed: ${new Date(msg.completedAt).toLocaleTimeString()}
                                ${msg.content ? `<div class="queue-item-content">${msg.content}</div>` : ''}
                            </div>
                        </div>
                    `;
                });
            }

            if (queue.length === 0 && streamingStates.size === 0 && renderingInProgress.size === 0 && processedMessages.length === 0) {
                html += '<div style="color: #666;">No messages in queue or processed yet</div>';
            }

            queuePanel.innerHTML = html;
        }

        // Hook into the renderer's addMessage to track when messages are added and completed
        function trackMessageLifecycle() {
            if (!messageRenderer) return;

            // Store original addMessage method
            const originalAddMessage = messageRenderer.addMessage.bind(messageRenderer);

            // Override addMessage to track messages
            messageRenderer.addMessage = async function (messageData) {
                console.log('🔵 Message added to queue:', messageData);

                // Add to processed history when completed
                const messageId = messageData.id || `msg-${Date.now()}`;

                try {
                    const result = await originalAddMessage(messageData);

                    // Track as completed
                    processedMessages.push({
                        id: messageId,
                        type: messageData.type,
                        content: messageData.content,
                        completedAt: Date.now()
                    });

                    // Keep only recent messages
                    if (processedMessages.length > maxProcessedHistory) {
                        processedMessages = processedMessages.slice(-maxProcessedHistory);
                    }

                    console.log('🟢 Message completed:', messageId);

                    return result;
                } catch (error) {
                    console.log('🔴 Message failed:', messageId, error);
                    throw error;
                }
            };
        }

        async function initializeTest() {
            try {
                updateStatus('Initializing unified message system...');

                // Initialize the unified message renderer
                // The renderer expects chatWindow to already exist in the DOM
                messageRenderer = new UnifiedMessageRenderer();

                // Initialize new SVG icon system
                // Make Icons globally available for the renderer
                window.Icons = Icons;

                // Set up message lifecycle tracking
                trackMessageLifecycle();

                updateStatus('✅ Unified message system ready!');

                // Start queue monitoring
                queueUpdateInterval = setInterval(updateQueuePanel, 50); // Update every 50ms for better responsiveness
                updateQueuePanel(); // Initial update

                // Make test functions globally available
                window.testUserMessage = testUserMessage;
                window.testAgentMessage = testAgentMessage;
                window.testAICompanionMessage = testAICompanionMessage;
                window.testThinkingMessage = testThinkingMessage;
                window.testSystemMessage = testSystemMessage;
                window.testErrorMessage = testErrorMessage;
                window.clearMessages = clearMessages;

            } catch (error) {
                console.error('Initialization error:', error);
                updateStatus('❌ Error: ' + error.message);
            }
        }

        function testUserMessage() {
            messageCounter++;
            messageRenderer.addMessage({
                type: MessageTypes.USER,
                content: `This is a test user message #${messageCounter}. Testing **markdown** support and proper icon display.`,
                sender: 'Test User',
                timestamp: new Date().toISOString(),
                showIcon: true,
                showMetadata: true
            });
        }

        function testAgentMessage() {
            messageCounter++;
            messageRenderer.addMessage({
                type: MessageTypes.AGENT,
                content: `This is a test agent message #${messageCounter}. I'm testing the agent message styling with proper icons and layout.`,
                sender: 'Assistant',
                timestamp: new Date().toISOString(),
                showIcon: true,
                showMetadata: true
            });
        }

        function testAICompanionMessage() {
            messageCounter++;
            messageRenderer.addMessage({
                type: MessageTypes.AI_COMPANION,
                content: `This is a test AI Companion message #${messageCounter}. The icon should be 28x28px and use the AI companion styling.`,
                sender: 'AI Companion',
                timestamp: new Date().toISOString(),
                showIcon: true,
                showMetadata: true
            });
        }

        function testThinkingMessage() {
            messageCounter++;
            messageRenderer.addMessage({
                type: MessageTypes.AI_COMPANION,
                content: `This is a test thinking message #${messageCounter}. This should show the AI companion with proper 28x28px icon (merged with AI companion type).`,
                sender: 'AI Companion',
                timestamp: new Date().toISOString(),
                showIcon: true,
                showMetadata: true
            });
        }

        function testSystemMessage() {
            messageCounter++;
            messageRenderer.addMessage({
                type: MessageTypes.SYSTEM,
                content: `System message #${messageCounter}: Testing system message display and icon styling.`,
                sender: 'System',
                timestamp: new Date().toISOString(),
                showIcon: true,
                showMetadata: true
            });
        }

        function testErrorMessage() {
            messageCounter++;
            messageRenderer.addMessage({
                type: MessageTypes.ERROR,
                content: `Error message #${messageCounter}: This is a test error message to verify error styling and icons.`,
                sender: 'System',
                timestamp: new Date().toISOString(),
                showIcon: true,
                showMetadata: true
            });
        }

        function clearMessages() {
            document.getElementById('chatWindow').innerHTML = '';
            messageCounter = 0;
            processedMessages = []; // Clear processed messages history
            updateStatus('Messages cleared. System ready for testing.');
            updateQueuePanel(); // Update queue panel immediately
        }

        // Make updateStatus globally available
        window.updateStatus = updateStatus;

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeTest);
    </script>
</body>

</html>