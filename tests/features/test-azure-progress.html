<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure Speech Progress Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .progress-container {
            margin: 10px 0;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            height: 25px;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            width: 0%;
            transition: width 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .test-controls {
            margin: 10px 0;
        }
        
        button {
            margin: 5px;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .status {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .provider-select {
            margin: 10px 0;
        }
        
        select, input {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            margin: 5px;
        }
        
        .test-text {
            width: 100%;
            height: 80px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: vertical;
        }
        
        .progress-stages {
            margin: 10px 0;
            font-size: 12px;
        }
        
        .stage {
            display: inline-block;
            margin: 2px;
            padding: 2px 6px;
            border-radius: 3px;
            background: #e9ecef;
        }
        
        .stage.active {
            background: #007bff;
            color: white;
        }
    </style>
</head>
<body>
    <h1>Azure Speech Progress Test</h1>
    <p>This specifically tests Azure Speech Services progress tracking using synthesis events.</p>
    
    <div class="test-section">
        <h3>Azure Configuration</h3>
        <div class="provider-select">
            <label for="azureKey">Azure Subscription Key:</label>
            <input type="password" id="azureKey" placeholder="Enter your Azure key" style="width: 300px;">
            <br>
            <label for="azureRegion">Azure Region:</label>
            <input type="text" id="azureRegion" value="eastus" placeholder="e.g., eastus">
            <br>
            <label for="azureVoice">Voice:</label>
            <select id="azureVoice">
                <option value="en-US-JennyNeural">Jenny (US Female)</option>
                <option value="en-US-GuyNeural">Guy (US Male)</option>
                <option value="en-US-AriaNeural">Aria (US Female)</option>
                <option value="en-GB-SoniaNeural">Sonia (UK Female)</option>
            </select>
        </div>
    </div>
    
    <div class="test-section">
        <h3>Test Text</h3>
        <textarea class="test-text" id="testText">
This is a comprehensive test of Azure Speech Services progress tracking. The progress should show preparation stages, synthesis events, and estimated playback progress. Azure Speech Services provides synthesis events that allow us to track when synthesis starts, when audio data is being generated, and when synthesis completes.
        </textarea>
    </div>
    
    <div class="test-section">
        <h3>Azure Speech Progress Test</h3>
        <div class="test-controls">
            <button id="testAzureSpeech">Test Azure Speech with Progress</button>
            <button id="stopSpeech">Stop Speech</button>
        </div>
        
        <div class="progress-stages">
            <span class="stage" id="stage-prep">Preparation (10%)</span>
            <span class="stage" id="stage-config">Config (20%)</span>
            <span class="stage" id="stage-ssml">SSML (30%)</span>
            <span class="stage" id="stage-start">Synthesis Start (40%)</span>
            <span class="stage" id="stage-synth">Synthesizing (40-60%)</span>
            <span class="stage" id="stage-complete">Synthesis Complete (70%)</span>
            <span class="stage" id="stage-playback">Playback (70-95%)</span>
            <span class="stage" id="stage-done">Complete (100%)</span>
        </div>
        
        <div class="progress-container">
            <div class="progress-bar" id="progressBar">0%</div>
        </div>
        
        <div class="status" id="statusLog">
            Ready to test Azure speech progress...<br>
            <strong>Note:</strong> You need a valid Azure Speech Services key and region to test this.
        </div>
    </div>

    <script>
        const progressBar = document.getElementById('progressBar');
        const statusLog = document.getElementById('statusLog');
        const testButton = document.getElementById('testAzureSpeech');
        const stopButton = document.getElementById('stopSpeech');
        const testText = document.getElementById('testText');
        
        let isTestRunning = false;
        let currentTest = null;
        
        // Log function
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            statusLog.innerHTML += `<br>[${timestamp}] ${message}`;
            statusLog.scrollTop = statusLog.scrollHeight;
            console.log(`[AzureTest] ${message}`);
        }
        
        // Update progress bar and stages
        function updateProgress(progress) {
            const percentage = Math.round(progress * 100);
            progressBar.style.width = `${percentage}%`;
            progressBar.textContent = `${percentage}%`;
            
            // Update stage indicators
            document.querySelectorAll('.stage').forEach(stage => stage.classList.remove('active'));
            
            if (percentage >= 10) document.getElementById('stage-prep').classList.add('active');
            if (percentage >= 20) document.getElementById('stage-config').classList.add('active');
            if (percentage >= 30) document.getElementById('stage-ssml').classList.add('active');
            if (percentage >= 40) document.getElementById('stage-start').classList.add('active');
            if (percentage >= 50) document.getElementById('stage-synth').classList.add('active');
            if (percentage >= 70) document.getElementById('stage-complete').classList.add('active');
            if (percentage >= 80) document.getElementById('stage-playback').classList.add('active');
            if (percentage >= 100) document.getElementById('stage-done').classList.add('active');
        }
        
        // Test Azure speech
        async function testAzureSpeech() {
            if (isTestRunning) {
                log('Test already running...');
                return;
            }
            
            const azureKey = document.getElementById('azureKey').value.trim();
            const azureRegion = document.getElementById('azureRegion').value.trim();
            const azureVoice = document.getElementById('azureVoice').value;
            const text = testText.value.trim();
            
            if (!azureKey) {
                log('‚ùå Please enter your Azure subscription key');
                return;
            }
            
            if (!azureRegion) {
                log('‚ùå Please enter your Azure region');
                return;
            }
            
            if (!text) {
                log('‚ùå Please enter some text to test');
                return;
            }
            
            try {
                isTestRunning = true;
                testButton.disabled = true;
                
                log(`üé§ Testing Azure Speech with voice: ${azureVoice}`);
                log(`üìç Region: ${azureRegion}`);
                log(`üìù Text length: ${text.length} characters`);
                
                // Reset progress
                updateProgress(0);
                
                // Import and configure speech engine
                const { SpeechEngine } = await import('./src/services/speechEngine.js');
                const speechEngine = new SpeechEngine();
                
                // Configure Azure settings
                speechEngine.settings.provider = 'azure';
                speechEngine.settings.azureSettings = {
                    subscriptionKey: azureKey,
                    region: azureRegion,
                    voiceName: azureVoice
                };
                
                log('üîß Initializing speech engine...');
                await speechEngine.initialize();
                
                log('üéØ Switching to Azure provider...');
                await speechEngine.switchProvider('azure');
                
                log('üöÄ Starting Azure speech synthesis with progress tracking...');
                
                // Start speech with progress tracking
                const success = await speechEngine.speakText(text, {
                    forceSpeak: true,
                    naturalness: 0.8,
                    onProgress: (progress) => {
                        updateProgress(progress);
                        log(`üìä Progress: ${Math.round(progress * 100)}%`);
                    },
                    onComplete: () => {
                        log('‚úÖ Azure speech synthesis completed successfully');
                        updateProgress(1.0);
                        isTestRunning = false;
                        testButton.disabled = false;
                    },
                    onError: (error) => {
                        log(`‚ùå Azure speech error: ${error.message}`);
                        isTestRunning = false;
                        testButton.disabled = false;
                    }
                });
                
                if (!success) {
                    log('‚ùå Azure speech synthesis failed');
                    isTestRunning = false;
                    testButton.disabled = false;
                }
                
            } catch (error) {
                log(`‚ùå Test failed: ${error.message}`);
                isTestRunning = false;
                testButton.disabled = false;
            }
        }
        
        // Stop speech
        async function stopSpeech() {
            if (currentTest) {
                log('üõë Stopping speech...');
                // Implementation depends on how the speech engine is exposed
                isTestRunning = false;
                testButton.disabled = false;
                updateProgress(0);
            }
        }
        
        // Event listeners
        testButton.addEventListener('click', testAzureSpeech);
        stopButton.addEventListener('click', stopSpeech);
        
        // Load saved Azure credentials if available
        const savedKey = localStorage.getItem('azureTestKey');
        const savedRegion = localStorage.getItem('azureTestRegion');
        if (savedKey) document.getElementById('azureKey').value = savedKey;
        if (savedRegion) document.getElementById('azureRegion').value = savedRegion;
        
        // Save credentials on change
        document.getElementById('azureKey').addEventListener('change', (e) => {
            localStorage.setItem('azureTestKey', e.target.value);
        });
        document.getElementById('azureRegion').addEventListener('change', (e) => {
            localStorage.setItem('azureTestRegion', e.target.value);
        });
    </script>
</body>
</html>
