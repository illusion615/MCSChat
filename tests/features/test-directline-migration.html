<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DirectLine Connection Status Migration Test</title>
    <link rel="stylesheet" href="../styles.css">
    <style>
        .test-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            border-radius: 8px;
        }
        
        .test-section {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .test-button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            background: #0078d4;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        .test-button:hover {
            background: #106ebe;
        }
        
        .test-button.secondary {
            background: #6c757d;
        }
        
        .test-button.secondary:hover {
            background: #5a6268;
        }
        
        .test-button.danger {
            background: #dc3545;
        }
        
        .test-button.danger:hover {
            background: #c82333;
        }
        
        .status-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 4px solid #0078d4;
        }
        
        .notification-zones {
            position: relative;
            height: 200px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            background: #fafafa;
            margin: 20px 0;
        }
        
        .zone-label {
            position: absolute;
            background: #0078d4;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .zone-label.connection {
            top: 10px;
            right: 10px;
        }
        
        .zone-label.initialization {
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .zone-label.logging {
            bottom: 10px;
            right: 10px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üîó DirectLine Connection Status Migration Test</h1>
        <p>Testing the migration of DirectLine connection status notifications to the unified notification system.</p>
        
        <div class="test-section">
            <h2>üìç Notification Zones</h2>
            <p>The connection status notifications should appear in the <strong>top-right (connection)</strong> zone:</p>
            <div class="notification-zones">
                <div class="zone-label connection">Connection Zone</div>
                <div class="zone-label initialization">Initialization Zone</div>
                <div class="zone-label logging">Logging Zone</div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>üß™ Connection Status Tests</h2>
            <p>Test different DirectLine connection status scenarios:</p>
            
            <div class="test-controls">
                <button class="test-button" onclick="testConnecting()">üîÑ Test Connecting</button>
                <button class="test-button" onclick="testOnline()">‚úÖ Test Online</button>
                <button class="test-button" onclick="testExpired()">‚è∞ Test Expired Token</button>
                <button class="test-button danger" onclick="testFailed()">‚ùå Test Failed</button>
                <button class="test-button danger" onclick="testEnded()">üíî Test Connection Ended</button>
                <button class="test-button secondary" onclick="clearAll()">üßπ Clear All</button>
            </div>
        </div>
        
        <div class="test-section">
            <h2>üîÑ Connection Flow Simulation</h2>
            <p>Simulate a complete connection sequence:</p>
            
            <div class="test-controls">
                <button class="test-button" onclick="simulateFullConnection()">üì± Simulate Full Connection</button>
                <button class="test-button" onclick="simulateConnectionFailure()">üí• Simulate Connection Failure</button>
                <button class="test-button" onclick="simulateTokenExpiry()">‚åõ Simulate Token Expiry</button>
            </div>
        </div>
        
        <div class="test-section">
            <h2>üìä System Status</h2>
            <div class="status-display" id="systemStatus">
                <strong>Unified Notification Manager:</strong> <span id="notificationStatus">Checking...</span><br>
                <strong>Connection Zone:</strong> <span id="connectionZoneStatus">Ready</span><br>
                <strong>Last Test:</strong> <span id="lastTest">None</span>
            </div>
        </div>
        
        <div class="test-section">
            <h2>üìù Test Log</h2>
            <div id="testLog" style="background: #000; color: #0f0; padding: 15px; border-radius: 4px; font-family: monospace; height: 200px; overflow-y: auto;">
                <div>DirectLine Connection Status Migration Test initialized...</div>
            </div>
        </div>
    </div>

    <!-- Include the unified notification manager -->
    <script src="../src/services/unifiedNotificationManager.js"></script>
    
    <script>
        // Initialize notification manager
        let unifiedNotificationManager;
        
        function initializeSystem() {
            try {
                unifiedNotificationManager = new UnifiedNotificationManager();
                window.unifiedNotificationManager = unifiedNotificationManager;
                
                updateStatus('notificationStatus', 'Loaded ‚úÖ');
                log('‚úÖ Unified Notification Manager initialized');
                
                // Test basic functionality
                setTimeout(() => {
                    unifiedNotificationManager.show({
                        id: 'system-ready',
                        message: 'DirectLine migration test system ready',
                        type: 'success',
                        zone: 'connection',
                        autoHide: 3000
                    });
                }, 500);
                
            } catch (error) {
                updateStatus('notificationStatus', 'Failed ‚ùå');
                log('‚ùå Failed to initialize: ' + error.message);
            }
        }
        
        function updateStatus(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) element.textContent = text;
        }
        
        function log(message) {
            const logElement = document.getElementById('testLog');
            if (logElement) {
                const timestamp = new Date().toLocaleTimeString();
                logElement.innerHTML += `<div>[${timestamp}] ${message}</div>`;
                logElement.scrollTop = logElement.scrollHeight;
            }
        }
        
        // Test functions that simulate DirectLine connection status events
        function testConnecting() {
            log('üîÑ Testing connecting status...');
            updateStatus('lastTest', 'Connecting');
            
            if (window.unifiedNotificationManager) {
                window.unifiedNotificationManager.show({
                    id: 'connection-status',
                    message: 'Connecting to bot...',
                    type: 'loading',
                    zone: 'connection',
                    persistent: true
                });
                log('‚úÖ Connection status notification shown (connecting)');
            } else {
                log('‚ùå Unified notification manager not available');
            }
        }
        
        function testOnline() {
            log('‚úÖ Testing online status...');
            updateStatus('lastTest', 'Online');
            
            if (window.unifiedNotificationManager) {
                window.unifiedNotificationManager.show({
                    id: 'connection-status',
                    message: 'Bot connected! Waiting for response...',
                    type: 'success',
                    zone: 'connection',
                    persistent: true
                });
                log('‚úÖ Connection status notification shown (online)');
                
                // Simulate the delayed progression like the real system
                setTimeout(() => {
                    window.unifiedNotificationManager.show({
                        id: 'connection-status',
                        message: 'Bot connected - ready to chat',
                        type: 'success',
                        zone: 'connection',
                        autoHide: 2000
                    });
                    log('‚úÖ Connection status updated (ready to chat)');
                }, 2000);
                
            } else {
                log('‚ùå Unified notification manager not available');
            }
        }
        
        function testExpired() {
            log('‚è∞ Testing expired token status...');
            updateStatus('lastTest', 'Expired Token');
            
            if (window.unifiedNotificationManager) {
                window.unifiedNotificationManager.hide('connection-status');
                log('‚úÖ Connection status cleared (expired token)');
                
                // The error message would be shown by showErrorMessage in real system
                setTimeout(() => {
                    window.unifiedNotificationManager.show({
                        id: 'error-demo',
                        message: 'Authentication token has expired. Please check your DirectLine secret.',
                        type: 'error',
                        zone: 'connection',
                        autoHide: 5000
                    });
                    log('‚úÖ Error message shown for expired token');
                }, 100);
                
            } else {
                log('‚ùå Unified notification manager not available');
            }
        }
        
        function testFailed() {
            log('‚ùå Testing failed connection status...');
            updateStatus('lastTest', 'Failed Connection');
            
            if (window.unifiedNotificationManager) {
                window.unifiedNotificationManager.hide('connection-status');
                log('‚úÖ Connection status cleared (failed connection)');
                
                setTimeout(() => {
                    window.unifiedNotificationManager.show({
                        id: 'error-demo',
                        message: 'Failed to connect to the bot service. Please check your DirectLine secret and internet connection.',
                        type: 'error',
                        zone: 'connection',
                        autoHide: 5000
                    });
                    log('‚úÖ Error message shown for failed connection');
                }, 100);
                
            } else {
                log('‚ùå Unified notification manager not available');
            }
        }
        
        function testEnded() {
            log('üíî Testing connection ended status...');
            updateStatus('lastTest', 'Connection Ended');
            
            if (window.unifiedNotificationManager) {
                window.unifiedNotificationManager.hide('connection-status');
                log('‚úÖ Connection status cleared (connection ended)');
                
                setTimeout(() => {
                    window.unifiedNotificationManager.show({
                        id: 'error-demo',
                        message: 'Connection to the bot has ended unexpectedly. Please try refreshing the page.',
                        type: 'error',
                        zone: 'connection',
                        autoHide: 5000
                    });
                    log('‚úÖ Error message shown for connection ended');
                }, 100);
                
            } else {
                log('‚ùå Unified notification manager not available');
            }
        }
        
        function clearAll() {
            log('üßπ Clearing all notifications...');
            updateStatus('lastTest', 'Clear All');
            
            if (window.unifiedNotificationManager) {
                window.unifiedNotificationManager.clearZone('connection');
                log('‚úÖ Connection zone cleared');
            } else {
                log('‚ùå Unified notification manager not available');
            }
        }
        
        function simulateFullConnection() {
            log('üì± Starting full connection simulation...');
            updateStatus('lastTest', 'Full Connection Simulation');
            
            // Step 1: Connecting
            testConnecting();
            
            // Step 2: Online after 2 seconds
            setTimeout(() => {
                testOnline();
            }, 2000);
            
            log('üì± Full connection simulation started (connecting ‚Üí online)');
        }
        
        function simulateConnectionFailure() {
            log('üí• Starting connection failure simulation...');
            updateStatus('lastTest', 'Connection Failure Simulation');
            
            // Step 1: Connecting
            testConnecting();
            
            // Step 2: Failed after 3 seconds
            setTimeout(() => {
                testFailed();
            }, 3000);
            
            log('üí• Connection failure simulation started (connecting ‚Üí failed)');
        }
        
        function simulateTokenExpiry() {
            log('‚åõ Starting token expiry simulation...');
            updateStatus('lastTest', 'Token Expiry Simulation');
            
            // Step 1: Online
            testOnline();
            
            // Step 2: Token expires after 5 seconds
            setTimeout(() => {
                testExpired();
            }, 5000);
            
            log('‚åõ Token expiry simulation started (online ‚Üí expired)');
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeSystem);
    </script>
</body>
</html>
