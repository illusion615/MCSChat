<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Citation System Test</title>
    <link rel="stylesheet" href="../styles.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .test-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .message-example {
            background: #e8f4f8;
            padding: 16px 20px;
            border-radius: 20px 20px 20px 4px;
            margin-bottom: 16px;
            border-left: 4px solid #3b82f6;
        }

        h1 {
            color: #1f2937;
            border-bottom: 2px solid #3b82f6;
            padding-bottom: 10px;
        }

        h2 {
            color: #374151;
            margin-top: 30px;
        }

        .demo-button {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            margin: 10px 5px;
        }

        .demo-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }
    </style>
</head>

<body>
    <h1>📚 Citation and Reference System Test</h1>

    <div class="test-container">
        <h2>🎯 Purpose</h2>
        <p>This page demonstrates the citation and reference system for agent responses that include entities data. When
            agents respond with content that includes citations from documents, the system automatically detects and
            displays them in a user-friendly format.</p>
    </div>

    <div class="test-container">
        <h2>📋 Enhanced Features</h2>
        <ul>
            <li><strong>DirectLine Support:</strong> Full support for Copilot Studio DirectLine response format</li>
            <li><strong>Multiple Citation Sources:</strong> Handles entities, channelData, and legacy JSON formats</li>
            <li><strong>Inline References:</strong> Clickable [1], [2] references in text that scroll to citations</li>
            <li><strong>Smart Parsing:</strong> Automatically extracts source documents and page numbers</li>
            <li><strong>Automatic Detection:</strong> Detects JSON arrays with citation data in agent responses</li>
            <li><strong>Grouped Display:</strong> Groups citations by source document for better organization</li>
            <li><strong>Expandable UI:</strong> Collapsible citations section to save space</li>
            <li><strong>Page Numbers:</strong> Shows specific page references when available</li>
            <li><strong>Content Preview:</strong> Displays truncated content from citations</li>
            <li><strong>Direct Links:</strong> Clickable links to view original sources</li>
            <li><strong>Responsive Design:</strong> Works well on desktop and mobile devices</li>
        </ul>
    </div>

    <div class="test-container">
        <h2>🔬 Test Example</h2>
        <p>Below is how a message with citations would appear:</p>

        <div class="message-example">
            <div>Based on the CL-8000i documentation, this is a dual-module automated chemiluminescent immunoassay
                analyzer capable of 500 tests per hour.</div>

            <!-- Example Citation Display -->
            <div class="citations-container">
                <div class="citations-header">
                    <span class="citations-icon">📚</span>
                    <span class="citations-title">References (3)</span>
                    <button class="citations-toggle" type="button">▼</button>
                </div>
                <div class="citations-list">
                    <div class="citation-item">
                        <div class="citation-header">
                            <span class="citation-number">[1]</span>
                            <span class="citation-source">CL8000i_工程师培训PPT_V1.0_CH.pdf</span>
                        </div>
                        <div class="citation-details">
                            <div class="citation-detail-item">
                                <span class="citation-page">Page 24</span>
                                <div class="citation-content">免疫CL-8000i 500测试/小时 免疫CL-8000i 500测试/小时 SPL 2000 1000样本/小时
                                    ©2012 Mindray Confidential...</div>
                                <button class="citation-link" type="button">🔗 View Source</button>
                            </div>
                        </div>
                    </div>
                    <div class="citation-item">
                        <div class="citation-header">
                            <span class="citation-number">[2]</span>
                            <span class="citation-source">BM80A_国内Mindray服务手册_全量版_compressed.pdf</span>
                        </div>
                        <div class="citation-details">
                            <div class="citation-detail-item">
                                <span class="citation-page">Page 173</span>
                                <div class="citation-content">CL-8000i/CL-8200i全自动化学发光免疫分析仪 服务手册 2了解产品 前面板按键面板组件零件位置图及
                                    FRU详细列表...</div>
                                <button class="citation-link" type="button">🔗 View Source</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="test-container">
        <h2>⚙️ How It Works</h2>
        <ol>
            <li><strong>Detection:</strong> The system scans agent responses for JSON arrays containing citation data
            </li>
            <li><strong>Parsing:</strong> Extracts fields like <code>SourceDocument</code>, <code>PageNum</code>,
                <code>ReferencePath</code>, and <code>content</code>
            </li>
            <li><strong>Grouping:</strong> Citations from the same document are grouped together</li>
            <li><strong>Rendering:</strong> Creates an interactive, collapsible citations section</li>
            <li><strong>Linking:</strong> Provides direct links to original sources when available</li>
        </ol>
    </div>

    <div class="test-container">
        <h2>🔧 Testing</h2>
        <p>To test the citation system:</p>
        <button class="demo-button" onclick="testCitationToggle()">Test Citation Toggle</button>
        <button class="demo-button" onclick="testCitationLink()">Test Citation Link</button>
        <button class="demo-button" onclick="testInlineReference()">Test Inline Reference</button>
        <button class="demo-button" onclick="testResponsiveDesign()">Test Responsive Design</button>
    </div>

    <script>
        // Add interactivity to the test citations
        document.addEventListener('DOMContentLoaded', function () {
            const toggleButton = document.querySelector('.citations-toggle');
            const citationsList = document.querySelector('.citations-list');

            if (toggleButton && citationsList) {
                toggleButton.addEventListener('click', function () {
                    const isExpanded = citationsList.style.display !== 'none';
                    citationsList.style.display = isExpanded ? 'none' : 'block';
                    toggleButton.textContent = isExpanded ? '▶' : '▼';
                    toggleButton.setAttribute('aria-expanded', !isExpanded);
                });
            }

            // Add click handlers to citation links
            const citationLinks = document.querySelectorAll('.citation-link');
            citationLinks.forEach(link => {
                link.addEventListener('click', function () {
                    alert('This would open the source document in a new tab.');
                });
            });
        });

        function testCitationToggle() {
            const toggleButton = document.querySelector('.citations-toggle');
            if (toggleButton) {
                toggleButton.click();
                alert('Citation toggle tested! The citations section should expand/collapse.');
            }
        }

        function testCitationLink() {
            const citationLink = document.querySelector('.citation-link');
            if (citationLink) {
                citationLink.click();
            }
        }

        function testInlineReference() {
            const inlineRef = document.querySelector('.inline-reference');
            if (inlineRef) {
                inlineRef.click();
                alert('Inline reference clicked! This should scroll to the corresponding citation and highlight it.');
            } else {
                alert('No inline references found in the test content.');
            }
        }

        function testResponsiveDesign() {
            const container = document.querySelector('.citations-container');
            if (container) {
                container.style.maxWidth = '300px';
                alert('Responsive design test: Container width reduced to 300px. Check how citations adapt!');
                setTimeout(() => {
                    container.style.maxWidth = '';
                }, 3000);
            }
        }
    </script>
</body>

</html>