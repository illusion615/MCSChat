<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speech Stop Test - Real Time Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            background: #f8f9fa;
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }
        .debug-panel {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        .stop-button {
            background: #dc3545;
        }
        .stop-button:hover {
            background: #c82333;
        }
        .test-button {
            background: #28a745;
        }
        .test-button:hover {
            background: #218838;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.speaking {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.stopped {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.ready {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #b3d7ff;
        }
    </style>
</head>
<body>
    <h1>üé§ Speech Stop Test - Real Time Debug</h1>
    
    <div class="test-section">
        <h2>Test Speech Stopping Functionality</h2>
        <p>This page tests the same speech stopping logic used in the chat application.</p>
        
        <button onclick="startLongSpeech()" class="test-button">Start Long Speech</button>
        <button onclick="testStopSpeech()" class="stop-button">Test Stop Speech</button>
        <button onclick="clearDebugLog()">Clear Log</button>
        
        <div id="speechStatus" class="status ready">Status: Ready to test</div>
    </div>

    <div class="test-section">
        <h3>Real-Time Debug Log</h3>
        <div id="debugLog" class="debug-panel">
            <div>Debug log will appear here...</div>
        </div>
    </div>

    <div class="test-section">
        <h3>Speech Stop Methods Being Tested</h3>
        <ul>
            <li><strong>Method 1:</strong> window.aiCompanion.stopSpeaking() - <span id="method1Status">Not Available</span></li>
            <li><strong>Method 2:</strong> window.speechEngine.stopSpeaking() - <span id="method2Status">Not Available</span></li>
            <li><strong>Method 3:</strong> window.speechSynthesis.cancel() - <span id="method3Status">Not Available</span></li>
        </ul>
    </div>

    <script>
        let testSpeechUtterance = null;
        let isTestSpeaking = false;

        function log(message) {
            const debugLog = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${timestamp}] ${message}`;
            debugLog.appendChild(logEntry);
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(`[SpeechStopTest] ${message}`);
        }

        function updateStatus(message, type = 'ready') {
            const statusEl = document.getElementById('speechStatus');
            statusEl.textContent = `Status: ${message}`;
            statusEl.className = `status ${type}`;
        }

        function checkAvailableMethods() {
            // Check Method 1: aiCompanion
            const method1El = document.getElementById('method1Status');
            if (window.aiCompanion && window.aiCompanion.stopSpeaking) {
                method1El.textContent = '‚úÖ Available';
                method1El.style.color = '#28a745';
            } else {
                method1El.textContent = '‚ùå Not Available';
                method1El.style.color = '#dc3545';
            }

            // Check Method 2: speechEngine
            const method2El = document.getElementById('method2Status');
            if (window.speechEngine && window.speechEngine.stopSpeaking) {
                method2El.textContent = '‚úÖ Available';
                method2El.style.color = '#28a745';
            } else {
                method2El.textContent = '‚ùå Not Available';
                method2El.style.color = '#dc3545';
            }

            // Check Method 3: speechSynthesis
            const method3El = document.getElementById('method3Status');
            if (typeof window.speechSynthesis !== 'undefined') {
                method3El.textContent = '‚úÖ Available';
                method3El.style.color = '#28a745';
            } else {
                method3El.textContent = '‚ùå Not Available';
                method3El.style.color = '#dc3545';
            }
        }

        function startLongSpeech() {
            if (isTestSpeaking) {
                log("Speech already in progress, stopping first...");
                testStopSpeech();
                return;
            }

            log("Starting long speech for testing...");
            
            if ('speechSynthesis' in window) {
                // Stop any ongoing speech first
                window.speechSynthesis.cancel();
                
                testSpeechUtterance = new SpeechSynthesisUtterance(
                    "This is a very long test speech that should take a significant amount of time to complete. " +
                    "The purpose of this speech is to test the speech stopping functionality. " +
                    "While this speech is playing, you should be able to stop it by clicking the stop button. " +
                    "This simulates the scenario where a user sends a new message while the AI is speaking. " +
                    "The speech should stop immediately when the stop button is clicked, just like when a user sends a new message in the chat application. " +
                    "If you can hear this entire message without interruption, then the stop functionality may not be working correctly. " +
                    "Please test the stop button while this message is playing to verify that the speech stopping works as expected."
                );
                
                testSpeechUtterance.rate = 0.7; // Slower for easier testing
                testSpeechUtterance.onstart = () => {
                    isTestSpeaking = true;
                    updateStatus("Speaking long test message...", "speaking");
                    log("Speech started successfully");
                };
                testSpeechUtterance.onend = () => {
                    isTestSpeaking = false;
                    updateStatus("Speech completed naturally", "ready");
                    log("Speech completed naturally (not stopped)");
                };
                testSpeechUtterance.onerror = (event) => {
                    isTestSpeaking = false;
                    updateStatus(`Speech error: ${event.error}`, "stopped");
                    log(`Speech error: ${event.error}`);
                };
                
                window.speechSynthesis.speak(testSpeechUtterance);
                log("Called window.speechSynthesis.speak()");
            } else {
                updateStatus("Speech synthesis not supported", "stopped");
                log("Speech synthesis not supported in this browser");
            }
        }

        function testStopSpeech() {
            log("Testing speech stop functionality...");
            
            let speechStopped = false;
            
            try {
                // Method 1: Use aiCompanion (same as chat app)
                if (window.aiCompanion && window.aiCompanion.stopSpeaking) {
                    log("Method 1: Calling window.aiCompanion.stopSpeaking()");
                    window.aiCompanion.stopSpeaking();
                    speechStopped = true;
                } else {
                    log("Method 1: aiCompanion not available");
                }
                
                // Method 2: Use speechEngine directly
                if (window.speechEngine && window.speechEngine.stopSpeaking) {
                    log("Method 2: Calling window.speechEngine.stopSpeaking()");
                    window.speechEngine.stopSpeaking();
                    speechStopped = true;
                } else {
                    log("Method 2: speechEngine not available");
                }
                
                // Method 3: Direct browser API (should always work)
                if (typeof window.speechSynthesis !== 'undefined') {
                    log("Method 3: Calling window.speechSynthesis.cancel()");
                    window.speechSynthesis.cancel();
                    speechStopped = true;
                } else {
                    log("Method 3: speechSynthesis not available");
                }
                
                if (speechStopped) {
                    isTestSpeaking = false;
                    updateStatus("Speech stopped by test", "stopped");
                    log("‚úÖ Speech stopping completed");
                } else {
                    log("‚ùå No speech stopping methods were available");
                    updateStatus("No stop methods available", "stopped");
                }
                
            } catch (error) {
                log(`‚ùå Error during speech stopping: ${error.message}`);
                updateStatus(`Stop error: ${error.message}`, "stopped");
            }
        }

        function clearDebugLog() {
            document.getElementById('debugLog').innerHTML = '<div>Debug log cleared...</div>';
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            log("Speech Stop Test page loaded");
            checkAvailableMethods();
            
            // Check for global objects periodically
            setInterval(checkAvailableMethods, 2000);
        });

        // Test keyboard shortcut
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                testStopSpeech();
            }
            if (event.key === ' ' && event.ctrlKey) {
                event.preventDefault();
                startLongSpeech();
            }
        });

        // Log when speech synthesis state changes
        if ('speechSynthesis' in window) {
            setInterval(() => {
                const speaking = window.speechSynthesis.speaking;
                const pending = window.speechSynthesis.pending;
                if (speaking || pending) {
                    log(`Speech state: speaking=${speaking}, pending=${pending}`);
                }
            }, 1000);
        }
    </script>
</body>
</html>
