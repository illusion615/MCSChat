<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speech Progress Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .progress-container {
            margin: 10px 0;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            height: 20px;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .test-controls {
            margin: 10px 0;
        }
        
        button {
            margin: 5px;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .status {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
        }
        
        .provider-select {
            margin: 10px 0;
        }
        
        select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        
        .test-text {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: vertical;
        }
    </style>
</head>
<body>
    <h1>Speech Progress Indicator Test</h1>
    <p>This page tests the speech progress functionality across different providers including preparation stages for Local AI.</p>
    
    <div class="test-section">
        <h3>Speech Provider Selection</h3>
        <div class="provider-select">
            <label for="speechProvider">Provider:</label>
            <select id="speechProvider">
                <option value="web_speech">Web Speech API</option>
                <option value="local_ai">Local AI (shows preparation progress)</option>
                <option value="azure">Azure Speech Services</option>
            </select>
        </div>
    </div>
    
    <div class="test-section">
        <h3>Test Text</h3>
        <textarea class="test-text" id="testText">
This is a comprehensive test of the speech progress indicator functionality. For Local AI, you should see preparation progress including model loading, voice configuration, text preparation, synthesis, and audio playback stages. For Web Speech API, you'll see real-time progress based on word boundaries. For Azure, you'll see preparation and synthesis progress with SSML processing.
        </textarea>
    </div>
    
    <div class="test-section">
        <h3>Speech Progress Test</h3>
        <div class="test-controls">
            <button id="testSpeech">Test Speech with Progress</button>
            <button id="stopSpeech">Stop Speech</button>
        </div>
        
        <div class="progress-container">
            <div class="progress-bar" id="progressBar">0%</div>
        </div>
        
        <div class="status" id="statusLog">
            Ready to test speech progress...
        </div>
    </div>
    
    <div class="test-section">
        <h3>Quick Tests</h3>
        <div class="test-controls">
            <button onclick="quickTest('short')">Short Text Test</button>
            <button onclick="quickTest('medium')">Medium Text Test</button>
            <button onclick="quickTest('long')">Long Text Test</button>
        </div>
    </div>

    <script type="module">
        import { SpeechEngine } from './src/services/speechEngine.js';
        
        let speechEngine;
        let isTestRunning = false;
        
        const progressBar = document.getElementById('progressBar');
        const statusLog = document.getElementById('statusLog');
        const testButton = document.getElementById('testSpeech');
        const stopButton = document.getElementById('stopSpeech');
        const providerSelect = document.getElementById('speechProvider');
        const testText = document.getElementById('testText');
        
        // Initialize speech engine
        async function initializeSpeech() {
            try {
                log('Initializing speech engine...');
                speechEngine = new SpeechEngine();
                await speechEngine.initialize();
                log('Speech engine initialized successfully');
            } catch (error) {
                log(`Failed to initialize speech engine: ${error.message}`);
            }
        }
        
        // Log function
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            statusLog.textContent = `[${timestamp}] ${message}`;
            console.log(`[SpeechTest] ${message}`);
        }
        
        // Update progress bar
        function updateProgress(progress) {
            const percentage = Math.round(progress * 100);
            progressBar.style.width = `${percentage}%`;
            progressBar.textContent = `${percentage}%`;
        }
        
        // Test speech with progress
        async function testSpeech() {
            if (isTestRunning) {
                log('Test already running...');
                return;
            }
            
            const text = testText.value.trim();
            if (!text) {
                log('Please enter some text to test');
                return;
            }
            
            const provider = providerSelect.value;
            
            try {
                isTestRunning = true;
                testButton.disabled = true;
                
                log(`Starting speech test with ${provider} provider...`);
                
                // Switch to selected provider
                await speechEngine.switchProvider(provider);
                log(`Switched to ${provider} provider`);
                
                // Reset progress
                updateProgress(0);
                
                // Start speech with progress tracking
                const success = await speechEngine.speakText(text, {
                    forceSpeak: true,
                    onProgress: (progress) => {
                        updateProgress(progress);
                        log(`Speech progress: ${Math.round(progress * 100)}%`);
                    },
                    onComplete: () => {
                        log('Speech synthesis completed successfully');
                        updateProgress(1.0);
                        isTestRunning = false;
                        testButton.disabled = false;
                    },
                    onError: (error) => {
                        log(`Speech error: ${error.message}`);
                        isTestRunning = false;
                        testButton.disabled = false;
                    }
                });
                
                if (!success) {
                    log('Speech synthesis failed');
                    isTestRunning = false;
                    testButton.disabled = false;
                }
                
            } catch (error) {
                log(`Speech test failed: ${error.message}`);
                isTestRunning = false;
                testButton.disabled = false;
            }
        }
        
        // Stop speech
        async function stopSpeech() {
            try {
                log('Stopping speech...');
                await speechEngine.stopSpeaking();
                log('Speech stopped');
                isTestRunning = false;
                testButton.disabled = false;
                updateProgress(0);
            } catch (error) {
                log(`Failed to stop speech: ${error.message}`);
            }
        }
        
        // Quick test function
        window.quickTest = async function(type) {
            const texts = {
                short: "This is a short test.",
                medium: "This is a medium length test to see how progress tracking works with a few sentences. The progress should update smoothly as the text is spoken.",
                long: "This is a comprehensive long text test that will help demonstrate the speech progress functionality across different stages. For Local AI providers, you should see preparation progress including model initialization, voice configuration, text processing, synthesis execution, and audio playback stages. The progress indicator should provide clear visual feedback throughout the entire speech generation process, helping users understand what's happening behind the scenes, especially during the typically longer Local AI synthesis times."
            };
            
            testText.value = texts[type];
            await testSpeech();
        };
        
        // Event listeners
        testButton.addEventListener('click', testSpeech);
        stopButton.addEventListener('click', stopSpeech);
        
        // Initialize on page load
        initializeSpeech();
    </script>
</body>
</html>
