<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Copilot Studio Companion - Test your Copilot Agent</title>
    <meta name="description"
        content="Sophisticated chatbot interface with multi-agent support, AI companion features, and real-time streaming capabilities">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="images/chat-new.svg">

    <!-- External Stylesheets -->
    <link rel="stylesheet" href="styles.css">

    <!-- External Libraries -->
    <!-- Adaptive Cards SDK -->
    <script src="https://unpkg.com/adaptivecards@2.9.0/dist/adaptivecards.min.js"></script>
    <!-- Bot Framework DirectLine JS -->
    <script src="https://unpkg.com/botframework-directlinejs@0.11.6/dist/directline.js"></script>
    <!-- Markdown Parser (local) -->
    <script src="lib/marked.min.js"></script>
    <!-- HTML Sanitizer (local) -->
    <script src="lib/purify.min.js"></script>
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" integrity="sha384-GvrOXuhMATgEsSwCs4smul74iXGOixntILdUW9XmUC6+HX0sLNAK3q71HotJqlAn" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js" integrity="sha384-cpW21h6RZv/phavutF+AuVYrr+dA8xD9zs6FwLpaCct6O9ctzYFfFr4dgmgccOTx" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>

    <!-- Fallback for offline usage -->
    <script>
        // Check if libraries loaded successfully, provide fallbacks if needed
        document.addEventListener('DOMContentLoaded', () => {
            const missingLibraries = [];

            if (typeof DirectLine === 'undefined') {
                console.error('DirectLine library failed to load');
                missingLibraries.push('DirectLine');
            }
            if (typeof marked === 'undefined') {
                console.error('Marked.js library failed to load');
                missingLibraries.push('marked');
            }
            if (typeof DOMPurify === 'undefined') {
                console.error('DOMPurify library failed to load');
                missingLibraries.push('DOMPurify');
            }
            if (typeof katex === 'undefined') {
                console.warn('KaTeX library failed to load - LaTeX math rendering will be disabled');
                // Note: This is non-critical, so we don't add it to missingLibraries
            }

            if (missingLibraries.length > 0) {
                console.warn(`Missing libraries: ${missingLibraries.join(', ')}. Application may not function properly.`);

                // Show error message to user
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #f8d7da;
                    color: #721c24;
                    padding: 15px;
                    border-radius: 8px;
                    border: 1px solid #f5c6cb;
                    z-index: 10000;
                    font-family: Arial, sans-serif;
                    max-width: 350px;
                `;
                errorDiv.innerHTML = `
                    <strong>Library Loading Error</strong><br>
                    Failed to load: ${missingLibraries.join(', ')}<br>
                    <small>Please check your internet connection.</small>
                `;
                document.body.appendChild(errorDiv);

                setTimeout(() => errorDiv.remove(), 10000);
            } else {
                console.log('All critical libraries loaded successfully');
                console.log('marked version:', marked?.VERSION || 'unknown');
                console.log('marked.parse available:', typeof marked.parse === 'function');
                console.log('DirectLine available:', typeof DirectLine !== 'undefined');
                console.log('KaTeX available:', typeof katex !== 'undefined');
                console.log('KaTeX version:', katex?.version || 'unknown');
            }
        });
    </script>
</head>

<body>
    <!-- Main Application Container -->
    <div id="container">
        <!-- Mobile Header with Hamburger Menu -->
        <div id="mobileHeader">
            <button id="mobileMenuToggle" class="mobile-menu-btn" aria-label="Toggle menu">
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
            </button>
            <h3 id="mobileTitle">Copilot Studio Companion</h3>
            <div class="mobile-actions">
                <button id="mobileAiToggle" class="mobile-action-btn" style="display: none;" title="AI Companion" aria-label="AI Companion">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <!-- Main document shape -->
                        <path d="M7 3H15L19 7V19C19 20.1 18.1 21 17 21H7C5.9 21 5 20.1 5 19V5C5 3.9 5.9 3 7 3Z" 
                              fill="currentColor" stroke="currentColor" stroke-width="0.5" fill-opacity="0.8"/>
                        <!-- Document corner fold -->
                        <path d="M15 3V7H19" fill="none" stroke="currentColor" stroke-width="0.5"/>
                        <!-- Document lines -->
                        <path d="M8 10H16M8 13H16M8 16H13" stroke="white" stroke-width="1" stroke-linecap="round" opacity="0.9"/>
                        <!-- Large sparkle (top right) -->
                        <g transform="translate(17,4)">
                            <path d="M0 -2L0.8 -0.8L2 0L0.8 0.8L0 2L-0.8 0.8L-2 0L-0.8 -0.8Z" 
                                  fill="currentColor" opacity="0.7"/>
                        </g>
                        <!-- Medium sparkle (bottom left) -->
                        <g transform="translate(3,16)">
                            <path d="M0 -1.5L0.6 -0.6L1.5 0L0.6 0.6L0 1.5L-0.6 0.6L-1.5 0L-0.6 -0.6Z" 
                                  fill="currentColor" opacity="0.6"/>
                        </g>
                        <!-- Small sparkle (top left) -->
                        <g transform="translate(4,6)">
                            <path d="M0 -1L0.4 -0.4L1 0L0.4 0.4L0 1L-0.4 0.4L-1 0L-0.4 -0.4Z" 
                                  fill="currentColor" opacity="0.5"/>
                        </g>
                        <!-- Tiny sparkle (right side) -->
                        <circle cx="20" cy="12" r="0.8" fill="currentColor" opacity="0.4"/>
                    </svg>
                </button>
                <button id="mobileNewChatBtn" class="mobile-action-btn" title="New chat">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                        <line x1="12" y1="8" x2="12" y2="14"/>
                        <line x1="9" y1="11" x2="15" y2="11"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Mobile Overlay for Sidebar -->
        <div id="mobileOverlay" class="mobile-overlay"></div>

        <!-- Left Sidebar Panel -->
        <div id="leftPanel">
            <!-- Close button for mobile -->
            <button id="mobileSidebarClose" class="mobile-close-btn" aria-label="Close menu">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" />
                </svg>
            </button>
            
            <!-- History Header -->
            <div id="historyHeader">
                <h3>Conversations</h3>
                <button id="clearButton" class="icon-button" title="New chat">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                        <line x1="12" y1="8" x2="12" y2="14"/>
                        <line x1="9" y1="11" x2="15" y2="11"/>
                    </svg>
                </button>
                <button id="clearAllHistoryButton" class="icon-button" title="Clear All History">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M9,3V4H4V6H5V19A2,2 0 0,0 7,21H17A2,2 0 0,0 19,19V6H20V4H15V3H9M7,6H17V19H7V6M9,8V17H11V8H9M13,8V17H15V8H13Z" />
                    </svg>
                </button>
            </div>
            <!-- Session List -->
            <div id="sessionList">
                <div class="loading-sessions">Loading chat history...</div>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div id="mainChatArea">
            <!-- Agent Chat Panel -->
            <div id="agentChatPanel" class="chat-panel">
                <div class="panel-header">
                    <h3 id="agentConversationTitle">Agent Conversation</h3>
                    <div class="panel-controls">
                        <span id="agentStatus" class="status-indicator" data-tooltip="Agent: Disconnected"></span>
                        <span id="agentName" class="agent-name"></span>
                        <button id="toggleLLMPanelBtn" class="icon-button" title="Toggle AI Companion Panel"
                            style="display: none;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                <!-- Main document shape -->
                                <path d="M7 3H15L19 7V19C19 20.1 18.1 21 17 21H7C5.9 21 5 20.1 5 19V5C5 3.9 5.9 3 7 3Z" 
                                      fill="#3B82F6" stroke="#2563EB" stroke-width="1"/>
                                <!-- Document corner fold -->
                                <path d="M15 3V7H19" fill="none" stroke="#2563EB" stroke-width="1"/>
                                <!-- Document lines -->
                                <path d="M8 10H16M8 13H16M8 16H13" stroke="white" stroke-width="1.2" stroke-linecap="round"/>
                                <!-- Large sparkle (top right) -->
                                <g transform="translate(17,4)">
                                    <path d="M0 -2L0.8 -0.8L2 0L0.8 0.8L0 2L-0.8 0.8L-2 0L-0.8 -0.8Z" 
                                          fill="#60A5FA"/>
                                </g>
                                <!-- Medium sparkle (bottom left) -->
                                <g transform="translate(3,16)">
                                    <path d="M0 -1.5L0.6 -0.6L1.5 0L0.6 0.6L0 1.5L-0.6 0.6L-1.5 0L-0.6 -0.6Z" 
                                          fill="#93C5FD"/>
                                </g>
                                <!-- Small sparkle (top left) -->
                                <g transform="translate(4,6)">
                                    <path d="M0 -1L0.4 -0.4L1 0L0.4 0.4L0 1L-0.4 0.4L-1 0L-0.4 -0.4Z" 
                                          fill="#DBEAFE"/>
                                </g>
                                <!-- Tiny sparkle (right side) -->
                                <circle cx="20" cy="12" r="0.8" fill="#BFDBFE"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Chat Window -->
                <div id="chatWindow" class="chat-window">
                    <div class="welcome-message">
                        <div class="welcome-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
                                <!-- Main document shape -->
                                <path d="M7 3H15L19 7V19C19 20.1 18.1 21 17 21H7C5.9 21 5 20.1 5 19V5C5 3.9 5.9 3 7 3Z" 
                                      fill="currentColor" stroke="currentColor" stroke-width="0.5" fill-opacity="0.8"/>
                                <!-- Document corner fold -->
                                <path d="M15 3V7H19" fill="none" stroke="currentColor" stroke-width="0.5"/>
                                <!-- Document lines -->
                                <path d="M8 10H16M8 13H16M8 16H13" stroke="white" stroke-width="1.2" stroke-linecap="round" opacity="0.9"/>
                                <!-- Large sparkle (top right) -->
                                <g transform="translate(17,4)">
                                    <path d="M0 -2L0.8 -0.8L2 0L0.8 0.8L0 2L-0.8 0.8L-2 0L-0.8 -0.8Z" 
                                          fill="currentColor" opacity="0.7"/>
                                </g>
                                <!-- Medium sparkle (bottom left) -->
                                <g transform="translate(3,16)">
                                    <path d="M0 -1.5L0.6 -0.6L1.5 0L0.6 0.6L0 1.5L-0.6 0.6L-1.5 0L-0.6 -0.6Z" 
                                          fill="currentColor" opacity="0.6"/>
                                </g>
                                <!-- Small sparkle (top left) -->
                                <g transform="translate(4,6)">
                                    <path d="M0 -1L0.4 -0.4L1 0L0.4 0.4L0 1L-0.4 0.4L-1 0L-0.4 -0.4Z" 
                                          fill="currentColor" opacity="0.5"/>
                                </g>
                                <!-- Tiny sparkle (right side) -->
                                <circle cx="20" cy="12" r="0.8" fill="currentColor" opacity="0.4"/>
                            </svg>
                        </div>
                        <h4>Welcome to Copilot Studio Companion</h4>
                        <p>Connect with your Copilot Studio agent to test and improve the agent user interactive experience, configure your bot in settings or start
                            typing to begin.</p>
                    </div>
                </div>

                <!-- Suggested Actions Container -->
                <div id="suggestedActionsContainer"></div>

                <!-- Input Container -->
                <div id="inputContainer">
                    <!-- File Upload -->
                    <div id="fileUploadContainer">
                        <input type="file" id="fileInput"
                            accept=".pdf,.doc,.docx,.txt,.xlsx,.pptx,.png,.jpg,.jpeg,.gif,.webp"
                            style="display: none;" />
                        <button id="attachButton" class="input-button" title="Attach file" aria-label="Attach file">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66L9.64 16.2a2 2 0 01-2.83-2.83l8.48-8.48" />
                            </svg>
                        </button>
                    </div>
                    <!-- Message Input -->
                    <input type="text" id="userInput" placeholder="Type your message..." autocomplete="off"
                        aria-label="Message input" />
                    <!-- Voice Input Button -->
                    <button id="voiceInputBtn" class="voice-input-btn" title="Voice input" aria-label="Voice input" 
                            style="display: none;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 1a3 3 0 0 1 3 3v8a3 3 0 0 1-6 0V4a3 3 0 0 1 3-3Z"/>
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                            <path d="M12 19v4"/>
                            <path d="M8 23h8"/>
                        </svg>
                    </button>
                    <!-- Send Button -->
                    <button id="sendButton" class="input-button primary" title="Send message" aria-label="Send message">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M4 12l1.41 1.41L11 7.83V20h2V7.83l5.59 5.58L20 12l-8-8z"/>
                        </svg>
                    </button>
                </div>

                <!-- File Preview Container -->
                <div id="filePreviewContainer" style="display: none;">
                    <div id="filePreview">
                        <div class="file-info">
                            <span id="fileName">filename.txt</span>
                            <span id="fileSize">1.2 KB</span>
                        </div>
                        <button id="removeFileButton" class="remove-file-btn" title="Remove file"
                            aria-label="Remove file">
                            &times;
                        </button>
                    </div>
                </div>
            </div>

            <!-- AI Companion Panel -->
            <div id="llmAnalysisPanel" class="chat-panel collapsed" style="display: none;">
                <div class="panel-header">
                    <div class="panel-title-section">
                        <button id="expandAiCompanionBtn" class="icon-button" title="Expand panel to 50/50 layout" aria-label="Expand AI Companion Panel">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                <rect x="3" y="3" width="7" height="18" rx="1"/>
                                <rect x="14" y="3" width="7" height="18" rx="1"/>
                                <path d="M10 8L13 12L10 16" stroke="currentColor" stroke-width="1.5" fill="none"/>
                            </svg>
                        </button>
                        <h3>Agent Companion</h3>
                    </div>
                    <div class="panel-controls">
                        <span id="llmStatus" class="status-indicator"></span>
                        <span id="llmModelName" class="agent-name"></span>
                    </div>
                </div>

                <!-- Real-time KPI Section -->
                <div id="agentKpiSection" class="kpi-section">
                    <div class="kpi-grid">
                        <div class="kpi-item">
                            <div class="kpi-label">Accuracy</div>
                            <div class="kpi-value" id="kpiAccuracy">-/10</div>
                            <div class="kpi-bar">
                                <div class="kpi-progress" id="kpiAccuracyBar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="kpi-item">
                            <div class="kpi-label">Helpfulness</div>
                            <div class="kpi-value" id="kpiHelpfulness">-/10</div>
                            <div class="kpi-bar">
                                <div class="kpi-progress" id="kpiHelpfulnessBar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="kpi-item">
                            <div class="kpi-label">Completeness</div>
                            <div class="kpi-value" id="kpiCompleteness">-/10</div>
                            <div class="kpi-bar">
                                <div class="kpi-progress" id="kpiCompletenessBar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="kpi-item">
                            <div class="kpi-label">Efficiency</div>
                            <div class="kpi-value" id="kpiEfficiency">-/10</div>
                            <div class="kpi-bar">
                                <div class="kpi-progress" id="kpiEfficiencyBar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="kpi-item">
                            <div class="kpi-label">Changes</div>
                            <div class="kpi-value">
                                <span id="kpiChanges">0</span>
                                <div class="kpi-trend" id="kpiChangesTrend">
                                    <span class="trend-arrow stable">‚Üí</span>
                                    <span class="trend-text">Stable</span>
                                </div>
                            </div>
                            <div class="kpi-bar">
                                <div class="kpi-progress" id="kpiChangesBar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="kpi-item">
                            <div class="kpi-label">AI Consumption</div>
                            <div class="kpi-value" id="kpiConsumption">0</div>
                            <div class="kpi-bar">
                                <div class="kpi-progress" id="kpiConsumptionBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- KPI Detail Modal -->
                <div id="kpiModal" class="kpi-modal">
                    <div class="kpi-modal-content">
                        <div class="kpi-modal-header">
                            <h3 id="kpiModalTitle">Score Details</h3>
                            <button class="kpi-modal-close" id="kpiModalClose">&times;</button>
                        </div>
                        <div class="kpi-modal-body">
                            <div class="kpi-score-display">
                                <span class="kpi-score-label">Current Score:</span>
                                <span class="kpi-score-value" id="kpiModalScore">-/10</span>
                            </div>
                            <div class="kpi-explanation" id="kpiModalExplanation">
                                <h4>How this score is calculated:</h4>
                                <div class="calculation-details" id="kpiModalDetails">
                                    <!-- Dynamic content will be inserted here -->
                                </div>
                            </div>
                            <div class="conversation-context" id="kpiModalContext">
                                <h4>Based on conversation analysis:</h4>
                                <div class="context-messages" id="kpiModalMessages">
                                    <!-- Dynamic content will be inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Chat Window -->
                <div id="llmChatWindow" class="chat-window">
                    <div class="companion-welcome">
                        <div class="companion-icon">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
                                <!-- Main document shape -->
                                <path d="M7 3H15L19 7V19C19 20.1 18.1 21 17 21H7C5.9 21 5 20.1 5 19V5C5 3.9 5.9 3 7 3Z" 
                                      fill="currentColor" stroke="currentColor" stroke-width="0.5" fill-opacity="0.8"/>
                                <!-- Document corner fold -->
                                <path d="M15 3V7H19" fill="none" stroke="currentColor" stroke-width="0.5"/>
                                <!-- Document lines -->
                                <path d="M8 10H16M8 13H16M8 16H13" stroke="white" stroke-width="1" stroke-linecap="round" opacity="0.9"/>
                                <!-- Large sparkle (top right) -->
                                <g transform="translate(17,4)">
                                    <path d="M0 -2L0.8 -0.8L2 0L0.8 0.8L0 2L-0.8 0.8L-2 0L-0.8 -0.8Z" 
                                          fill="currentColor" opacity="0.7"/>
                                </g>
                                <!-- Medium sparkle (bottom left) -->
                                <g transform="translate(3,16)">
                                    <path d="M0 -1.5L0.6 -0.6L1.5 0L0.6 0.6L0 1.5L-0.6 0.6L-1.5 0L-0.6 -0.6Z" 
                                          fill="currentColor" opacity="0.6"/>
                                </g>
                                <!-- Small sparkle (top left) -->
                                <g transform="translate(4,6)">
                                    <path d="M0 -1L0.4 -0.4L1 0L0.4 0.4L0 1L-0.4 0.4L-1 0L-0.4 -0.4Z" 
                                          fill="currentColor" opacity="0.5"/>
                                </g>
                                <!-- Tiny sparkle (right side) -->
                                <circle cx="20" cy="12" r="0.8" fill="currentColor" opacity="0.4"/>
                            </svg>
                        </div>
                        <p>AI Companion ready to analyze conversations and provide insights.</p>
                    </div>
                </div>

                <!-- AI Companion Notifications Area -->
                <div id="aiCompanionNotifications" class="ai-notifications-area">
                    <!-- Progress indicators and system notifications will appear here -->
                </div>

                <!-- AI Input Container -->
                <div id="llmInputContainer">
                    <!-- Quick Actions -->
                    <div class="llm-quick-actions">
                        <button class="quick-action-btn" data-action="analyze" title="Analyze agent responses">
                            Analyze Response
                        </button>
                        <button class="quick-action-btn" data-action="summarize" title="Summarize conversation">
                            Summarize Chat
                        </button>
                        <button class="quick-action-btn" data-action="benchmark" title="Run A/B test: Compare agent response with general knowledge">
                            A/B Test Response
                        </button>
                    </div>

                    <!-- Context Indicator -->
                    <div class="context-indicator">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M11,9H13V7H11M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M11,17H13V11H11V17Z" />
                        </svg>
                        <span>Full conversation context automatically included (adaptive)</span>
                    </div>

                    <!-- AI Input Field -->
                    <div id="llmInputField">
                        <textarea id="llmUserInput" placeholder="Ask AI companion to analyze agent performance..."
                            rows="2" aria-label="AI companion input"></textarea>
                        <button id="llmSendButton" class="input-button primary" title="Send to AI companion"
                            aria-label="Send to AI companion">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M4 12l1.41 1.41L11 7.83V20h2V7.83l5.59 5.58L20 12l-8-8z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Drag Bar for Resizing -->
        <div id="dragBar" style="display: none;"></div>

        <!-- Right Panel for External Content -->
        <div id="rightPanel" style="display: none;">
            <div class="panel-header">
                <h3>External Content</h3>
                <button id="closeButton" class="close-button" title="Close panel" aria-label="Close panel">
                    &times;
                </button>
            </div>
            <iframe id="embeddedBrowser" style="width: 100%; height: calc(100% - 60px); border: none;"
                title="External content frame"></iframe>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="modal" role="dialog" aria-labelledby="imageModalTitle" aria-hidden="true">
        <span class="closeModal" title="Close image" aria-label="Close image">&times;</span>
        <img class="modal-content" id="enlargedImage" alt="Enlarged image" />
        <div id="imageModalTitle" class="sr-only">Enlarged Image View</div>
    </div>

    <!-- Setup Modal -->
    <div id="setupModal" class="modal" role="dialog" aria-labelledby="setupModalTitle" aria-hidden="true">
        <div class="modal-content setup-modal">
            <div class="modal-header">
                <h2 id="setupModalTitle">Bot Configuration</h2>
                <button class="kpi-modal-close" id="closeSetupModal" title="Close configuration"
                    aria-label="Close configuration">&times;</button>
            </div>

            <div class="modal-body">
                <!-- Settings Navigation -->
                <div class="settings-navigation">
                    <ul class="nav-list">
                        <li><a href="#agent-section" class="nav-item active" data-section="agent-section">Agent
                                Management</a></li>
                        <li><a href="#ai-companion-section" class="nav-item" data-section="ai-companion-section">AI
                                Companion</a></li>
                        <li><a href="#appearance-section" class="nav-item"
                                data-section="appearance-section">Appearance</a></li>
                    </ul>
                </div>

                <!-- Settings Content -->
                <div class="settings-content">
                    <!-- Agent Management Section -->
                    <div id="agent-section" class="settings-section active">
                        <h3 class="section-title">Agent Management</h3>

                        <!-- Agent Management -->
                        <div class="form-group">
                            <div class="agents-header">
                                <label for="agentsList">Configured Agents:</label>
                                <button type="button" id="addNewAgentBtn" class="btn btn-secondary btn-small"
                                    title="Add new agent">+ Add New Agent</button>
                            </div>
                            <div id="agentsList" class="agents-list" role="list">
                                <div class="no-agents-message">No agents configured. Click "Add New Agent" to create
                                    your first
                                    agent.</div>
                            </div>
                        </div>

                        <!-- Agent Configuration Section -->
                        <div id="agentConfigSection" style="display: none;">
                            <div class="config-header">
                                <h3 id="configTitle">Add New Agent</h3>
                                <button type="button" id="cancelConfigBtn"
                                    class="btn btn-secondary btn-small">Cancel</button>
                            </div>

                            <div class="form-group">
                                <label for="agentNameInput">Agent Name:</label>
                                <input type="text" id="agentNameInput"
                                    placeholder="Enter agent name (e.g., Customer Support Bot)"
                                    aria-describedby="agentNameHelp" />
                                <small id="agentNameHelp" class="help-text">A friendly name to identify this
                                    agent</small>
                            </div>

                            <div class="form-group">
                                <label for="secretInput">DirectLine Secret:</label>
                                <div class="input-with-button">
                                    <input type="password" id="secretInput"
                                        placeholder="Enter your DirectLine secret..." aria-describedby="secretHelp" />
                                    <button type="button" id="toggleSecretVisibility" title="Show/Hide secret"
                                        aria-label="Toggle secret visibility">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"
                                            id="eyeIcon">
                                            <path
                                                d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z" />
                                        </svg>
                                    </button>
                                </div>
                                <small id="secretHelp" class="help-text">DirectLine secret from Azure Bot Service for
                                    this
                                    agent</small>
                            </div>

                            <div class="form-group">
                                <div class="connection-status" id="connectionStatus">
                                    <span class="status-indicator" id="statusIndicator"></span>
                                    <span class="status-text" id="statusText">Not connected</span>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="button" id="testAgentBtn" class="btn btn-secondary"
                                    title="Test DirectLine connection">Test Connection</button>
                                <button type="button" id="saveAgentBtn" class="btn btn-primary"
                                    title="Save agent configuration">Save Agent</button>
                            </div>
                        </div>

                        <!-- Current Active Agent Display -->
                        <div class="form-group">
                            <label>Currently Active Agent:</label>
                            <div class="current-agent-display" id="currentAgentDisplay">
                                <span id="currentAgentName">No agent selected</span>
                                <span class="agent-status disconnected" id="currentAgentStatus">Disconnected</span>
                            </div>
                        </div>

                        <!-- Streaming Options - moved here -->
                        <div class="form-group">
                            <label>Agent Options:</label>
                            <div class="feature-options">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="enableStreamingCheckbox" />
                                    <span class="checkmark"></span>
                                    Enable streaming responses (simulation mode)
                                </label>
                                <small class="help-text">Simulates progressive response display for better UX</small>

                                <label class="checkbox-label">
                                    <input type="checkbox" id="enableSideBrowserCheckbox" />
                                    <span class="checkmark"></span>
                                    Open citations in side browser
                                </label>
                                <small class="help-text">View citation sources within the app instead of external
                                    browser</small>

                                <label class="checkbox-label">
                                    <input type="checkbox" id="fullWidthMessagesCheckbox" />
                                    <span class="checkmark"></span>
                                    Display agent messages in full width
                                </label>
                                <small class="help-text">Show agent responses across the full panel width for maximum
                                    information display</small>
                            </div>
                        </div>

                        <!-- Speech Settings -->
                        <div class="form-group">
                            <label>Speech Settings:</label>
                            
                            <!-- Speech Behavior Group -->
                            <div class="speech-behavior-group">
                                <h4 class="sub-section-title">‚öôÔ∏è Speech Behavior</h4>
                                
                                <div class="feature-options">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="speechAutoSpeak" />
                                        <span class="checkmark"></span>
                                        Auto-speak agent messages when they arrive
                                    </label>
                                    <small class="help-text">Automatically read agent responses aloud using text-to-speech</small>

                                    <label class="checkbox-label">
                                        <input type="checkbox" id="speechVoiceInput" />
                                        <span class="checkmark"></span>
                                        Enable voice input (microphone)
                                    </label>
                                    <small class="help-text">Allow sending messages using voice commands</small>
                                </div>
                            </div>
                            
                            <!-- Speech Provider & Voice Selection Group -->
                            <div class="speech-provider-group">
                                <h4 class="sub-section-title">üé§ Voice & Provider</h4>
                                
                                <!-- Speech Provider Selection -->
                                <div class="form-row">
                                    <label for="speechProvider">Speech Provider:</label>
                                    <select id="speechProvider" class="speech-select">
                                        <option value="web_speech">Enhanced Web Speech API (Recommended)</option>
                                        <option value="local_ai">Local AI Models (Offline)</option>
                                        <option value="azure">Azure Speech Services (Premium)</option>
                                    </select>
                                </div>
                                <small class="help-text">
                                    <strong>Enhanced Web Speech API:</strong> Instant, reliable, high-quality voices (Recommended)<br>
                                    <strong>Local AI Models:</strong> Offline neural voices with 5 personality options (30-60s loading)<br>
                                    <strong>Azure Speech Services:</strong> Premium neural voices with highest naturalness (Requires subscription)
                                </small>
                                
                                <!-- Voice Selection -->
                                <div class="form-row">
                                    <label for="speechVoiceSelect">Voice:</label>
                                    <select id="speechVoiceSelect" class="speech-select">
                                        <option value="">Loading voices...</option>
                                    </select>
                                </div>
                                <small class="help-text">
                                    <strong>Web Speech API:</strong> System voices (varies by OS/browser)<br>
                                    <strong>Local AI:</strong> Neutral ‚Ä¢ Warm ‚Ä¢ Confident ‚Ä¢ Gentle ‚Ä¢ Energetic<br>
                                    <strong>Azure:</strong> Premium neural voices with regional accents
                                </small>
                                
                                <!-- Test Speech Button -->
                                <div class="form-row">
                                    <button type="button" id="testSpeechBtn" class="btn btn-small btn-secondary">
                                        üîä Test Voice
                                    </button>
                                </div>

                                <!-- Azure Settings (shown when Azure provider is selected) -->
                                <div id="azureSpeechSettings" class="azure-settings" style="display: none;">
                                    <h4>Azure Speech Services Configuration</h4>
                                    <p class="config-note">
                                        <strong>Note:</strong> Azure Speech Services requires a valid subscription key and region. 
                                        <a href="https://portal.azure.com/#create/Microsoft.CognitiveServicesSpeechServices" target="_blank">Create an Azure Speech resource</a> 
                                        to get your subscription key.
                                    </p>
                                    <div class="form-row">
                                        <label for="azureSubscriptionKey">Subscription Key: <span class="required">*</span></label>
                                        <input type="password" id="azureSubscriptionKey" placeholder="Enter Azure Speech subscription key" class="form-input" required>
                                    </div>
                                    <div class="form-row">
                                        <label for="azureRegion">Region:</label>
                                        <select id="azureRegion" class="speech-select">
                                            <option value="eastus">East US</option>
                                            <option value="westus">West US</option>
                                            <option value="westus2">West US 2</option>
                                            <option value="eastus2">East US 2</option>
                                            <option value="centralus">Central US</option>
                                            <option value="northcentralus">North Central US</option>
                                            <option value="southcentralus">South Central US</option>
                                            <option value="westcentralus">West Central US</option>
                                            <option value="canadacentral">Canada Central</option>
                                            <option value="brazilsouth">Brazil South</option>
                                            <option value="northeurope">North Europe</option>
                                            <option value="westeurope">West Europe</option>
                                            <option value="francecentral">France Central</option>
                                            <option value="germanywestcentral">Germany West Central</option>
                                            <option value="uksouth">UK South</option>
                                            <option value="switzerlandnorth">Switzerland North</option>
                                            <option value="uaenorth">UAE North</option>
                                            <option value="southafricanorth">South Africa North</option>
                                            <option value="centralindia">Central India</option>
                                            <option value="eastasia">East Asia</option>
                                            <option value="southeastasia">Southeast Asia</option>
                                            <option value="japaneast">Japan East</option>
                                            <option value="japanwest">Japan West</option>
                                            <option value="koreacentral">Korea Central</option>
                                            <option value="australiaeast">Australia East</option>
                                        </select>
                                    </div>
                                    <div class="form-row">
                                        <label for="azureVoiceName">Azure Voice:</label>
                                        <select id="azureVoiceName" class="speech-select">
                                            <option value="en-US-JennyNeural">Jenny (US Female)</option>
                                            <option value="en-US-AriaNeural">Aria (US Female)</option>
                                            <option value="en-US-GuyNeural">Guy (US Male)</option>
                                            <option value="en-US-DavisNeural">Davis (US Male)</option>
                                            <option value="en-GB-SoniaNeural">Sonia (UK Female)</option>
                                            <option value="en-GB-RyanNeural">Ryan (UK Male)</option>
                                            <option value="en-AU-NatashaNeural">Natasha (AU Female)</option>
                                            <option value="en-AU-WilliamNeural">William (AU Male)</option>
                                        </select>
                                    </div>
                                    <small class="help-text">Azure Speech Services provides premium neural voices with high naturalness</small>
                                </div>
                            </div>

                            <!-- Multi-Language Settings Group -->
                            <div class="multi-language-group">
                                <h4 class="sub-section-title">üåç Multi-Language Support</h4>
                                
                                <div class="feature-options">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="autoDetectLanguage" />
                                        <span class="checkmark"></span>
                                        Auto-detect language and switch voice
                                    </label>
                                    <small class="help-text">Automatically detect the language of text and select appropriate voice for TTS</small>

                                    <label class="checkbox-label">
                                        <input type="checkbox" id="enableLanguageDetection" />
                                        <span class="checkmark"></span>
                                        Enable speech language identification
                                    </label>
                                    <small class="help-text">Automatically identify the language of spoken input (Azure Speech only)</small>

                                    <label class="checkbox-label">
                                        <input type="checkbox" id="continuousLanguageDetection" />
                                        <span class="checkmark"></span>
                                        Continuous language detection
                                    </label>
                                    <small class="help-text">Continuously identify language during speech recognition (may impact performance)</small>
                                </div>

                                <!-- Language Candidates Selection -->
                                <div class="form-row">
                                    <label for="candidateLanguages">Expected Languages:</label>
                                    <select id="candidateLanguages" multiple class="speech-select multi-select" size="6">
                                        <option value="en-US" selected>English (US)</option>
                                        <option value="en-GB">English (UK)</option>
                                        <option value="es-ES">Spanish (Spain)</option>
                                        <option value="es-MX">Spanish (Mexico)</option>
                                        <option value="fr-FR">French</option>
                                        <option value="de-DE">German</option>
                                        <option value="zh-CN">Chinese (Simplified)</option>
                                        <option value="zh-TW">Chinese (Traditional)</option>
                                        <option value="ja-JP">Japanese</option>
                                        <option value="ko-KR">Korean</option>
                                        <option value="ru-RU">Russian</option>
                                        <option value="ar-SA">Arabic</option>
                                        <option value="hi-IN">Hindi</option>
                                        <option value="pt-BR">Portuguese (Brazil)</option>
                                        <option value="it-IT">Italian</option>
                                        <option value="nl-NL">Dutch</option>
                                    </select>
                                </div>
                                <small class="help-text">
                                    Hold Ctrl/Cmd to select multiple languages. This improves accuracy for speech recognition 
                                    and provides better voice matching for text-to-speech.
                                </small>
                            </div>

                            <!-- Speech Controls Group -->
                            <div class="speech-controls">
                                <h4 class="sub-section-title">üéõÔ∏è Voice Controls</h4>
                                
                                <!-- Speech Rate -->
                                <div class="form-row">
                                    <label for="speechRate">Speaking Rate:</label>
                                    <div class="slider-container">
                                        <input type="range" id="speechRate" min="0.5" max="2" step="0.1" value="1" class="speech-slider">
                                        <span class="slider-value" id="speechRateValue">1.0x</span>
                                    </div>
                                </div>

                                <!-- Speech Volume -->
                                <div class="form-row">
                                    <label for="speechVolume">Volume:</label>
                                    <div class="slider-container">
                                        <input type="range" id="speechVolume" min="0" max="100" step="5" value="100" class="speech-slider">
                                        <span class="slider-value" id="speechVolumeValue">100%</span>
                                    </div>
                                </div>

                                <!-- Naturalness Setting -->
                                <div class="form-row">
                                    <label for="speechNaturalness">Naturalness:</label>
                                    <div class="slider-container">
                                        <input type="range" id="speechNaturalness" min="0" max="100" step="10" value="80" class="speech-slider">
                                        <span class="slider-value" id="speechNaturalnessValue">80%</span>
                                    </div>
                                </div>
                                <small class="help-text">Higher values provide more natural speech but may be slower</small>
                            </div>
                        </div>
                    </div>

                    <!-- AI Companion Section -->
                    <div id="ai-companion-section" class="settings-section">
                        <h3 class="section-title">AI Companion</h3>

                        <!-- AI Companion Enable/Disable -->
                        <div class="form-group">
                            <label>AI Companion Settings:</label>
                            <div class="feature-options">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="enableLLMCheckbox" />
                                    <span class="checkmark"></span>
                                    Enable AI Companion (requires API key or local Ollama)
                                </label>
                                <small class="help-text">AI assistant for conversation analysis and insights</small>
                            </div>
                        </div>

                        <!-- API Configuration Section -->
                        <div id="apiKeySection" style="display: none;">
                            <div class="form-group">
                                <label for="apiProviderSelect">AI Provider:</label>
                                <select id="apiProviderSelect" aria-describedby="providerHelp">
                                    <option value="openai">OpenAI GPT</option>
                                    <option value="anthropic">Anthropic Claude</option>
                                    <option value="azure">Azure OpenAI</option>
                                    <option value="ollama">Local Ollama</option>
                                </select>
                                <small id="providerHelp" class="help-text">Choose your preferred AI provider</small>
                            </div>

                            <!-- API Key Field -->
                            <div id="apiKeyField" class="form-group">
                                <label for="apiKeyInput">API Key:</label>
                                <input type="password" id="apiKeyInput" placeholder="Enter your API key..."
                                    aria-describedby="apiKeyHelp" />
                                <small id="apiKeyHelp" class="help-text">API key for the selected provider</small>
                            </div>

                            <!-- Azure OpenAI Configuration -->
                            <div id="azureConfig" style="display: none;">
                                <div class="form-group">
                                    <label for="azureEndpointInput">Azure Endpoint:</label>
                                    <input type="url" id="azureEndpointInput"
                                        placeholder="https://your-resource.openai.azure.com"
                                        aria-describedby="azureEndpointHelp" />
                                    <small id="azureEndpointHelp" class="help-text">Azure OpenAI service endpoint
                                        URL</small>
                                </div>

                                <div class="form-group">
                                    <label for="azureDeploymentInput">Deployment Name:</label>
                                    <input type="text" id="azureDeploymentInput" placeholder="gpt-4o-mini"
                                        aria-describedby="azureDeploymentHelp" />
                                    <small id="azureDeploymentHelp" class="help-text">Azure OpenAI deployment model
                                        name</small>
                                </div>

                                <div class="form-group">
                                    <label for="azureApiVersionInput">API Version:</label>
                                    <input type="text" id="azureApiVersionInput" placeholder="2024-02-01"
                                        value="2024-02-01" aria-describedby="azureApiVersionHelp" />
                                    <small id="azureApiVersionHelp" class="help-text">Azure OpenAI API version</small>
                                </div>

                                <div class="form-group">
                                    <button type="button" id="testAzureBtn" class="btn btn-secondary">
                                        Test Azure OpenAI Connection
                                    </button>
                                </div>
                            </div>

                            <!-- General API Test Button -->
                            <div id="apiTestSection" style="display: none;">
                                <div class="form-group">
                                    <button type="button" id="testApiBtn" class="btn btn-secondary">
                                        Test API Connection
                                    </button>
                                </div>
                            </div>

                            <!-- Ollama Configuration -->
                            <div id="ollamaConfig" style="display: none;">
                                <div class="form-group">
                                    <label for="ollamaUrlInput">Ollama Server URL:</label>
                                    <input type="url" id="ollamaUrlInput" placeholder="http://localhost:11434"
                                        value="http://localhost:11434" aria-describedby="ollamaUrlHelp" />
                                    <small id="ollamaUrlHelp" class="help-text">URL of your local Ollama server</small>
                                </div>

                                <div class="form-group">
                                    <label for="ollamaModelSelect">Available Models:</label>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <select id="ollamaModelSelect" style="flex: 1;" aria-describedby="modelHelp">
                                            <option value="">Select a model...</option>
                                        </select>
                                        <button type="button" id="refreshModelsBtn" class="btn btn-secondary btn-small">
                                            Refresh Models
                                        </button>
                                    </div>
                                    <small id="modelHelp" class="help-text">Models available on your Ollama
                                        server</small>
                                </div>

                                <div class="form-group">
                                    <button type="button" id="testOllamaBtn" class="btn btn-secondary">
                                        Test Ollama Connection
                                    </button>
                                </div>

                                <!-- Hidden field for backward compatibility -->
                                <input type="hidden" id="ollamaModelInput" />
                            </div>
                        </div>

                        <!-- Model Comparison View -->
                        <div class="form-group">
                            <label style="margin-bottom: 10px;">Token Usage Across Models:</label>
                            <div class="model-comparison-container">
                                <div class="model-comparison-header">
                                    <button type="button" id="refreshModelComparisonBtn" class="btn btn-small btn-secondary">
                                        Refresh Data
                                    </button>
                                    <button type="button" id="resetAllModelsBtn" class="btn btn-small btn-danger" style="margin-left: 8px;">
                                        Reset All Models
                                    </button>
                                </div>
                                <div id="modelComparisonTable" class="model-comparison-table">
                                    <!-- Dynamic content will be populated here -->
                                </div>
                            </div>
                            <small class="help-text">Compare token efficiency across different AI models you've used</small>
                        </div>
                    </div>

                    <!-- Appearance Section -->
                    <div id="appearance-section" class="settings-section">
                        <h3 class="section-title">Appearance</h3>

                        <!-- Message Icon Toggle -->
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="messageIconToggle" checked />
                                <span class="checkmark"></span>
                                Show message icons
                            </label>
                            <small class="help-text">Display user and agent avatars next to messages</small>
                        </div>

                        <!-- User Icon Selection -->
                        <div class="form-group" id="userIconGroup">
                            <label>User Icon:</label>
                            <div class="user-icon-selection">
                                <div class="current-icon-preview">
                                    <div class="icon-preview" id="currentUserIconPreview">
                                        <!-- Current selected icon will be shown here -->
                                    </div>
                                    <span class="current-icon-label">Current Icon</span>
                                </div>
                                <div class="icon-options">
                                    <div class="icon-option" data-icon="friendly">
                                        <div class="icon-preview friendly-avatar"></div>
                                        <span class="icon-name">Friendly</span>
                                    </div>
                                    <div class="icon-option" data-icon="robot">
                                        <div class="icon-preview robot-avatar"></div>
                                        <span class="icon-name">Robot</span>
                                    </div>
                                    <div class="icon-option" data-icon="assistant">
                                        <div class="icon-preview assistant-avatar"></div>
                                        <span class="icon-name">Assistant</span>
                                    </div>
                                    <div class="icon-option" data-icon="smart">
                                        <div class="icon-preview smart-avatar"></div>
                                        <span class="icon-name">Smart</span>
                                    </div>
                                    <div class="icon-option" data-icon="modern">
                                        <div class="icon-preview modern-avatar"></div>
                                        <span class="icon-name">Modern</span>
                                    </div>
                                    <div class="icon-option" data-icon="cute">
                                        <div class="icon-preview cute-avatar"></div>
                                        <span class="icon-name">Cute</span>
                                    </div>
                                    <div class="icon-option" data-icon="professional">
                                        <div class="icon-preview professional-avatar"></div>
                                        <span class="icon-name">Professional</span>
                                    </div>
                                    <div class="icon-option" data-icon="gaming">
                                        <div class="icon-preview gaming-avatar"></div>
                                        <span class="icon-name">Gaming</span>
                                    </div>
                                    <div class="icon-option" data-icon="minimal">
                                        <div class="icon-preview minimal-avatar"></div>
                                        <span class="icon-name">Minimal</span>
                                    </div>
                                    <div class="icon-option" data-icon="carter">
                                        <div class="icon-preview carter-avatar"></div>
                                        <span class="icon-name">Carter</span>
                                    </div>
                                    <div class="icon-option" data-icon="custom">
                                        <div class="icon-preview custom-icon">
                                            <input type="file" id="customIconInput" accept="image/*" style="display: none;">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                                            </svg>
                                        </div>
                                        <span class="icon-name">Custom</span>
                                    </div>
                                </div>
                                <small class="help-text">Choose an icon to represent yourself in conversations</small>
                            </div>
                        </div>

                        <!-- Font Size Configuration - moved to bottom -->
                        <div class="form-group">
                            <label>Font Size Settings:</label>
                            <div class="font-size-config">
                                <!-- Agent Chat Font Size -->
                                <div class="font-size-setting">
                                    <label for="agentFontSize">Agent Chat Font Size:</label>
                                    <div style="display: flex; align-items: center; gap: 8px; margin-top: 5px;">
                                        <input type="range" id="agentFontSize" min="10" max="20" value="15" step="1"
                                            style="flex: 1;" aria-describedby="agentFontHelp" />
                                        <span id="agentFontSizeValue" class="font-size-value">15px</span>
                                    </div>
                                    <small id="agentFontHelp" class="help-text">Adjust font size for agent conversation
                                        messages</small>
                                </div>

                                <!-- AI Companion Font Size -->
                                <div class="font-size-setting" style="margin-top: 12px;">
                                    <label for="companionFontSize">AI Companion Font Size:</label>
                                    <div style="display: flex; align-items: center; gap: 8px; margin-top: 5px;">
                                        <input type="range" id="companionFontSize" min="8" max="16" value="12" step="1"
                                            style="flex: 1;" aria-describedby="companionFontHelp" />
                                        <span id="companionFontSizeValue" class="font-size-value">12px</span>
                                    </div>
                                    <small id="companionFontHelp" class="help-text">Adjust font size for AI companion
                                        messages</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Old loading indicator removed - now using unified notification system -->

    <!-- Side Browser for Citations -->
    <div id="sideBrowser" class="side-browser">
        <div class="side-browser-header">
            <h3 id="sideBrowserTitle">Citation Source</h3>
            <button id="closeSideBrowser" class="side-browser-close" title="Close browser">√ó</button>
        </div>
        <div id="sideBrowserContent" class="side-browser-content">
            <iframe id="sideBrowserFrame" src="about:blank" title="Citation content"></iframe>
            <div id="sideBrowserLoader" class="side-browser-loader">
                <div class="loader-spinner"></div>
                <p>Loading citation source...</p>
            </div>
            <div id="sideBrowserError" class="side-browser-error" style="display: none;">
                <p>Unable to load citation source. This content may be blocked by security policies.</p>
                <button id="openExternalBtn" class="btn btn-secondary">Open in External Browser</button>
            </div>
        </div>
    </div>

    <!-- Old logging panel removed - now using unified notification system -->

    <!-- Side Command Bar - Vertical Activity Bar -->
    <div id="sideCommandBar">
        <!-- Primary functions - top aligned -->
        <button id="conversationsButton" class="side-command-btn" title="Conversations" aria-label="Toggle conversations panel">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M20,2H4A2,2 0 0,0 2,4V16A2,2 0 0,0 4,18H18L22,22V4A2,2 0 0,0 20,2M6,9V7H18V9H6M14,11V13H6V11H14M16,15V17H6V15H16Z" />
            </svg>
        </button>
        
        <!-- Secondary functions - bottom aligned -->
        <button id="documentationButton" class="side-command-btn" title="Documentation" aria-label="View Documentation">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M11,18H13V16H11V18M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,6A4,4 0 0,0 8,10H10A2,2 0 0,1 12,8A2,2 0 0,1 14,10C14,12 11,11.75 11,15H13C13,12.75 16,12.5 16,10A4,4 0 0,0 12,6Z" />
            </svg>
        </button>
        <!-- Logging button removed - using unified notification system -->
        <button id="settingsButton" class="side-command-btn" title="Settings" aria-label="Settings">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 15.5A3.5 3.5 0 0 1 8.5 12A3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5 3.5 3.5 0 0 1-3.5 3.5m7.43-2.53c.04-.32.07-.64.07-.97c0-.33-.03-.66-.07-1l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.31-.61-.22l-2.49 1c-.52-.39-1.06-.73-1.69-.98l-.37-2.65A.506.506 0 0 0 14 2h-4c-.25 0-.46.18-.5.42l-.37 2.65c-.63.25-1.17.59-1.69.98l-2.49-1c-.22-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64L4.57 11c-.04.34-.07.67-.07 1c0 .33.03.65.07.97l-2.11 1.66c-.19.15-.25.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1.01c.52.4 1.06.74 1.69.99l.37 2.65c.04.24.25.42.5.42h4c.25 0 .46-.18.5-.42l.37-2.65c.63-.26 1.17-.59 1.69-.99l2.49 1.01c.22.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.66Z" />
            </svg>
        </button>
    </div>    <!-- Screen Reader Only Content -->
    <div class="sr-only">
        <div id="liveRegion" aria-live="polite" aria-atomic="false"></div>
    </div>

    <!-- Application Scripts -->
    <script type="module" src="src/main.js"></script>
</body>

</html>