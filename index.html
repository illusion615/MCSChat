<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Copilot Studio Companion - Test your Copilot Agent</title>
    <meta name="description"
        content="Sophisticated chatbot interface with multi-agent support, AI companion features, and real-time streaming capabilities">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" href="images/Microsoft-Copilot-Logo-30.png">

    <!-- External Stylesheets -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="src/ui/unifiedMessageStyles.css">

    <!-- External Libraries -->
    <!-- Adaptive Cards SDK -->
    <script src="https://unpkg.com/adaptivecards@2.9.0/dist/adaptivecards.min.js"></script>
    <!-- Bot Framework DirectLine JS -->
    <script src="https://unpkg.com/botframework-directlinejs@0.11.6/dist/directline.js"></script>
    <!-- Markdown Parser (local) -->
    <script src="lib/marked.min.js"></script>
    <!-- HTML Sanitizer (local) -->
    <script src="lib/purify.min.js"></script>
    <!-- KaTeX for LaTeX math rendering (local files) -->
    <link rel="stylesheet" href="lib/katex.min.css">
    <script defer src="lib/katex.min.js"></script>
    <script defer src="lib/auto-render.min.js"></script>

    <!-- Emergency localStorage cleanup to fix JSON parsing errors -->
    <script src="emergency-cleanup.js"></script>

    <!-- Fallback for offline usage -->
    <script>
        // Check if libraries loaded successfully, provide fallbacks if needed
        document.addEventListener('DOMContentLoaded', () => {
            const missingLibraries = [];

            if (typeof DirectLine === 'undefined') {
                console.error('DirectLine library failed to load');
                missingLibraries.push('DirectLine');
            }
            if (typeof marked === 'undefined') {
                console.error('Marked.js library failed to load');
                missingLibraries.push('marked');
            }
            if (typeof DOMPurify === 'undefined') {
                console.error('DOMPurify library failed to load');
                missingLibraries.push('DOMPurify');
            }
            if (typeof katex === 'undefined') {
                console.warn('KaTeX library failed to load - LaTeX math rendering will be disabled');
                // Note: This is non-critical, so we don't add it to missingLibraries
            }

            if (missingLibraries.length > 0) {
                console.warn(`Missing libraries: ${missingLibraries.join(', ')}. Application may not function properly.`);

                // Show error message to user
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #f8d7da;
                    color: #721c24;
                    padding: 15px;
                    border-radius: 8px;
                    border: 1px solid #f5c6cb;
                    z-index: 10000;
                    font-family: Arial, sans-serif;
                    max-width: 350px;
                `;
                errorDiv.innerHTML = `
                    <strong>Library Loading Error</strong><br>
                    Failed to load: ${missingLibraries.join(', ')}<br>
                    <small>Please check your internet connection.</small>
                `;
                document.body.appendChild(errorDiv);

                setTimeout(() => errorDiv.remove(), 10000);
            } else {
                console.log('All critical libraries loaded successfully');
                console.log('marked version:', marked?.VERSION || 'unknown');
                console.log('marked.parse available:', typeof marked.parse === 'function');
                console.log('DirectLine available:', typeof DirectLine !== 'undefined');
                console.log('KaTeX available:', typeof katex !== 'undefined');
                console.log('KaTeX version:', katex?.version || 'unknown');

                // Initialize KaTeX auto-render if available
                if (typeof katex !== 'undefined' && typeof renderMathInElement !== 'undefined') {
                    console.log('Initializing KaTeX auto-render...');
                    // Set up auto-render configuration
                    const katexOptions = {
                        delimiters: [
                            { left: '$$', right: '$$', display: true },
                            { left: '$', right: '$', display: false },
                            { left: '\\[', right: '\\]', display: true },
                            { left: '\\(', right: '\\)', display: false }
                        ],
                        throwOnError: false,
                        errorColor: '#cc0000'
                    };

                    // Auto-render math in document
                    try {
                        renderMathInElement(document.body, katexOptions);
                        console.log('KaTeX auto-render initialized successfully');
                    } catch (error) {
                        console.warn('KaTeX auto-render initialization failed:', error);
                    }
                }
            }
        });
    </script>
</head>

<body>
    <!-- Main Application Container -->
    <div id="container">
        <!-- Mobile Header with Hamburger Menu -->
        <div id="mobileHeader">
            <button id="mobileMenuToggle" class="mobile-menu-btn" aria-label="Toggle menu">
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
            </button>
            <h3 id="mobileTitle">Copilot Studio Companion</h3>
            <div class="mobile-actions">
                <button id="mobileAiToggle" class="mobile-action-btn" style="display: none;" title="AI Companion"
                    aria-label="AI Companion">
                    <!-- Icon will be populated by JavaScript -->
                </button>
                <button id="mobileKnowledgeHubBtn" class="mobile-action-btn" title="Knowledge Hub"
                    aria-label="Knowledge Hub">
                    <!-- Icon will be populated by JavaScript -->
                </button>
                <button id="mobileNewChatBtn" class="mobile-action-btn" title="New chat">
                    <!-- Icon will be populated by JavaScript -->
                </button>
            </div>
        </div>

        <!-- Mobile Overlay for Sidebar -->
        <div id="mobileOverlay" class="mobile-overlay"></div>

        <!-- Left Sidebar Panel -->
        <div id="leftPanel">
            <!-- History Header -->
            <div id="historyHeader">
                <h3>Conversations</h3>
                <button id="clearButton" class="icon-button" title="New chat" data-icon="newChat">
                    <!-- Icon will be populated by JavaScript -->
                </button>

                <button id="clearAllHistoryButton" class="icon-button" title="Clear All History" data-icon="delete">
                </button>
            </div>
            <!-- Session List -->
            <div id="sessionList">
                <div class="loading-sessions">Loading chat history...</div>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div id="mainChatArea">
            <!-- Agent Chat Panel -->
            <div id="agentChatPanel" class="chat-panel">
                <div class="panel-header">
                    <h3 id="agentConversationTitle">Agent Conversation</h3>
                    <div>
                    <div class="panel-controls">
                        <span id="agentStatus" class="status-indicator" data-tooltip="Agent: Disconnected"></span>
                        <span id="agentName" class="agent-name"></span>
                        <button id="togglerightpanelbtn" class="icon-button" title="Toggle Right Panel"
                            style="display: none;">
                        </button>
                    </div>
                    <div class="panel-controls">
                        <span id="llmStatus" class="status-indicator"></span>
                        <span id="llmModelName" class="agent-name"></span>
                    </div></div>
                </div>

                <!-- Chat Window -->
                <div id="chatWindow" class="chat-window">
                    <div class="welcome-message">
                        <div class="welcome-icon" data-icon="welcomeDocument">
                            <!-- Icon will be populated by JavaScript -->
                        </div>
                        <h4>Welcome to Copilot Studio Companion</h4>
                        <p>Connect with your Copilot Studio agent to test and improve the agent user interactive
                            experience, configure your bot in settings or start
                            typing to begin.</p>
                    </div>
                </div>

                <!-- Suggested Actions Container -->
                <div id="suggestedActionsContainer"></div>

                <!-- Input Container -->
                <div id="llmInputContainer">
                    <div id="llmQuickActionsContainer" class="llm-quick-actions-container">
                        <div class="llm-quick-actions">
                            <button class="quick-action-btn" data-action="analyze" title="Analyze agent responses">
                                Analyze Response
                            </button>
                            <button class="quick-action-btn" data-action="summarize" title="Summarize conversation">
                                Summarize Chat
                            </button>
                            <button class="quick-action-btn" data-action="benchmark"
                                title="Run A/B test: Compare agent response with general knowledge">
                                A/B Test Response
                            </button>
                        </div>
                    </div>
                    <div id="inputContainer">
                        <!-- File Upload -->
                        <div id="fileUploadContainer">
                            <input type="file" id="fileInput"
                                accept=".pdf,.doc,.docx,.txt,.xlsx,.pptx,.png,.jpg,.jpeg,.gif,.webp"
                                style="display: none;" />
                            <button id="attachButton" class="input-button" title="Attach file" aria-label="Attach file"
                                data-icon="attach">
                                <!-- Icon will be populated by JavaScript -->
                            </button>
                        </div>
                        <!-- Message Input -->
                        <input type="text" id="userInput" placeholder="Type your message..." autocomplete="off"
                            aria-label="Message input" />
                        <!-- Voice Input Button -->
                        <button id="voiceInputBtn" class="voice-input-btn" title="Voice input" aria-label="Voice input"
                            style="display: none; margin-right: 8px;" data-icon="microphone">
                            <!-- Icon will be populated by JavaScript -->
                        </button>
                        <!-- AI Companion Toggle Button -->
                        <button id="aiCompanionToggleBtn" class="voice-input-btn ai-companion-toggle"
                            title="AI Companion" aria-label="Toggle AI Companion mode"
                            style="display: none; margin-right: 8px;">
                            <!-- Icon will be populated by JavaScript -->
                        </button>
                        <!-- Send Button -->
                        <button id="sendButton" class="input-button primary" title="Send message"
                            aria-label="Send message" data-icon="send">
                            <!-- Icon will be populated by JavaScript -->
                        </button>
                    </div>
                </div>

                <!-- File Preview Container -->
                <div id="filePreviewContainer" style="display: none;">
                    <div id="filePreview">
                        <div class="file-info">
                            <span id="fileName">filename.txt</span>
                            <span id="fileSize">1.2 KB</span>
                        </div>
                        <button id="removeFileButton" class="remove-file-btn" title="Remove file"
                            aria-label="Remove file">
                            &times;
                        </button>
                    </div>
                </div>
            </div>

            <!-- AI Companion Panel -->
            <div id="llmAnalysisPanel" class="chat-panel collapsed" style="display: none;">
                <div class="panel-header">
                    <div class="panel-title-section">
                        <button id="expandAiCompanionBtn" class="icon-button" title="Expand panel to 50/50 layout"
                            aria-label="Expand AI Companion Panel">
                        </button>
                        <h3>Agent Performance</h3>
                    </div>
                    
                </div>

                <!-- Real-time KPI Section -->
                <div id="agentKpiSection" class="kpi-section">
                    <div class="kpi-grid">
                        <div class="kpi-item">
                            <div class="kpi-label">Accuracy</div>
                            <div class="kpi-value" id="kpiAccuracy">-/10</div>
                            <div class="kpi-bar">
                                <div class="kpi-progress" id="kpiAccuracyBar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="kpi-item">
                            <div class="kpi-label">Helpfulness</div>
                            <div class="kpi-value" id="kpiHelpfulness">-/10</div>
                            <div class="kpi-bar">
                                <div class="kpi-progress" id="kpiHelpfulnessBar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="kpi-item">
                            <div class="kpi-label">Completeness</div>
                            <div class="kpi-value" id="kpiCompleteness">-/10</div>
                            <div class="kpi-bar">
                                <div class="kpi-progress" id="kpiCompletenessBar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="kpi-item">
                            <div class="kpi-label">Efficiency</div>
                            <div class="kpi-value" id="kpiEfficiency">-/10</div>
                            <div class="kpi-bar">
                                <div class="kpi-progress" id="kpiEfficiencyBar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="kpi-item">
                            <div class="kpi-label">Changes</div>
                            <div class="kpi-value">
                                <span id="kpiChanges">0</span>
                                <div class="kpi-trend" id="kpiChangesTrend">
                                    <span class="trend-arrow stable">‚Üí</span>
                                    <span class="trend-text">Stable</span>
                                </div>
                            </div>
                            <div class="kpi-bar">
                                <div class="kpi-progress" id="kpiChangesBar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="kpi-item">
                            <div class="kpi-label">AI Consumption</div>
                            <div class="kpi-value" id="kpiConsumption">0</div>
                            <div class="kpi-bar">
                                <div class="kpi-progress" id="kpiConsumptionBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- KPI Explanation Area -->
                <div id="kpiExplanationArea" class="kpi-explanation-area" style="display: none;">
                    <div class="kpi-explanation-header">
                        <h4>üìä KPI Analysis & Insights</h4>
                        <button id="kpiExplanationToggle" class="kpi-explanation-toggle" title="Toggle KPI Explanation">
                            <span>‚ñº</span>
                        </button>
                    </div>
                    <div id="kpiExplanationContent" class="kpi-explanation-content">
                        <!-- KPI explanation will be dynamically inserted here -->
                    </div>
                </div>

                <!-- KPI Detail Modal -->
                <div id="kpiModal" class="kpi-modal">
                    <div class="kpi-modal-content">
                        <div class="kpi-modal-header">
                            <h3 id="kpiModalTitle">Score Details</h3>
                            <button class="kpi-modal-close" id="kpiModalClose">&times;</button>
                        </div>
                        <div class="kpi-modal-body">
                            <div class="kpi-score-display">
                                <span class="kpi-score-label">Current Score:</span>
                                <span class="kpi-score-value" id="kpiModalScore">-/10</span>
                            </div>
                            <div class="kpi-explanation" id="kpiModalExplanation">
                                <h4>How this score is calculated:</h4>
                                <div class="calculation-details" id="kpiModalDetails">
                                    <!-- Dynamic content will be inserted here -->
                                </div>
                            </div>
                            <div class="conversation-context" id="kpiModalContext">
                                <h4>Based on conversation analysis:</h4>
                                <div class="context-messages" id="kpiModalMessages">
                                    <!-- Dynamic content will be inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Chat Window -->
                <div id="llmChatWindow" class="chat-window">
                    <div class="companion-welcome">
                        <div class="companion-icon" id="companionIcon">
                        </div>
                        <p>AI Companion ready to analyze conversations and provide insights.</p>
                    </div>
                </div>

                <!-- AI Companion Notifications Area -->
                <div id="aiCompanionNotifications" class="ai-notifications-area">
                    <!-- Progress indicators and system notifications will appear here -->
                </div>
            </div>
        </div>

        <!-- Drag Bar for Resizing -->
        <div id="dragBar" style="display: none;"></div>

        <!-- Right Panel for External Content -->
        <div id="rightPanel" style="display: none;">
            <div class="panel-header">
                <h3>External Content</h3>
                <button id="closeButton" class="close-button" title="Close panel" aria-label="Close panel">
                    &times;
                </button>
            </div>
            <iframe id="embeddedBrowser" style="width: 100%; height: calc(100% - 60px); border: none;"
                title="External content frame"></iframe>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="modal" role="dialog" aria-labelledby="imageModalTitle" aria-hidden="true">
        <span class="closeModal" title="Close image" aria-label="Close image">&times;</span>
        <img class="modal-content" id="enlargedImage" alt="Enlarged image" />
        <div id="imageModalTitle" class="sr-only">Enlarged Image View</div>
    </div>

    <!-- Knowledge Hub Modal -->
    <div id="knowledgeHubModal" class="modal" role="dialog" aria-labelledby="knowledgeHubModalTitle" aria-hidden="true">
        <div class="modal-content knowledge-hub-modal">
            <div class="modal-header">
                <h2 id="knowledgeHubModalTitle">Knowledge Hub</h2>
                <span class="closeModal" title="Close Knowledge Hub" aria-label="Close Knowledge Hub">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Upload Section -->
                <div id="uploadSection" class="upload-section">
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon" data-icon="document" data-width="48" data-height="48">
                            <!-- Icon will be populated by main.js unified icon system -->
                        </div>
                        <h3>Upload PDF Document</h3>
                        <p>Drag and drop a PDF file here or click to browse</p>
                        <input type="file" id="pdfFileInput" accept=".pdf" style="display: none;">
                        <button class="btn btn-primary" id="browseButton">Browse Files</button>
                    </div>
                    <div class="upload-progress" id="uploadProgress" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="progress-text" id="progressText">Processing...</div>
                    </div>
                </div>

                <!-- Gallery Section -->
                <div id="gallerySection" class="gallery-section" style="display: none;">
                    <div class="gallery-header">
                        <h3 id="documentTitle">Document Pages</h3>
                        <div class="gallery-controls">
                            <button class="btn btn-secondary" id="backToUpload">Upload New Document</button>
                            <button class="btn btn-secondary" id="deleteDocument">Delete Document</button>
                        </div>
                    </div>
                    <div class="page-gallery" id="pageGallery">
                        <!-- Pages will be dynamically added here -->
                    </div>
                </div>

                <!-- Document Library Section -->
                <div id="librarySection" class="library-section">
                    <h3>Document Library</h3>
                    <div class="document-list" id="documentList">
                        <!-- Documents will be listed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Setup Modal -->
    <div id="setupModal" class="modal" role="dialog" aria-labelledby="setupModalTitle" aria-hidden="true">
        <div class="modal-content setup-modal">
            <div class="modal-header">
                <h2 id="setupModalTitle">Bot Configuration</h2>
                <button class="kpi-modal-close" id="closeSetupModal" title="Close configuration"
                    aria-label="Close configuration">&times;</button>
            </div>

            <div class="modal-body">
                <!-- Settings Navigation -->
                <div class="settings-navigation">
                    <ul class="nav-list">
                        <li><a href="#agent-section" class="nav-item active" data-section="agent-section">Agent
                                Management</a></li>
                        <li><a href="#ai-companion-section" class="nav-item" data-section="ai-companion-section">AI
                                Companion</a></li>
                        <li><a href="#appearance-section" class="nav-item"
                                data-section="appearance-section">Appearance</a></li>
                    </ul>
                </div>

                <!-- Settings Content -->
                <div class="settings-content">
                    <!-- Agent Management Section -->
                    <div id="agent-section" class="settings-section active">
                        <h3 class="section-title">Agent Management</h3>

                        <!-- Agent Management -->
                        <div class="form-group">
                            <div class="agents-header">
                                <label for="agentsList">Configured Agents:</label>
                                <button type="button" id="addNewAgentBtn" class="btn btn-secondary btn-small"
                                    title="Add new agent">+ Add New Agent</button>
                            </div>
                            <div id="agentsList" class="agents-list" role="list">
                                <div class="no-agents-message">No agents configured. Click "Add New Agent" to create
                                    your first
                                    agent.</div>
                            </div>
                        </div>

                        <!-- Agent Configuration Section -->
                        <div id="agentConfigSection" style="display: none;">
                            <div class="config-header">
                                <h3 id="configTitle">Add New Agent</h3>
                                <button type="button" id="cancelConfigBtn"
                                    class="btn btn-secondary btn-small">Cancel</button>
                            </div>

                            <div class="form-group">
                                <label for="agentNameInput">Agent Name:</label>
                                <input type="text" id="agentNameInput"
                                    placeholder="Enter agent name (e.g., Customer Support Bot)"
                                    aria-describedby="agentNameHelp" />
                                <small id="agentNameHelp" class="help-text">A friendly name to identify this
                                    agent</small>
                            </div>

                            <div class="form-group">
                                <label for="secretInput">DirectLine Secret:</label>
                                <div class="input-with-button">
                                    <input type="password" id="secretInput"
                                        placeholder="Enter your DirectLine secret..." aria-describedby="secretHelp" />
                                    <button type="button" id="toggleSecretVisibility" title="Show/Hide secret"
                                        aria-label="Toggle secret visibility" data-icon="eye">
                                        <!-- Icon will be populated by main.js unified icon system -->
                                    </button>
                                </div>
                                <small id="secretHelp" class="help-text">DirectLine secret from Azure Bot Service for
                                    this
                                    agent</small>
                            </div>

                            <div class="form-group">
                                <div class="connection-status" id="connectionStatus">
                                    <span class="status-indicator" id="statusIndicator"></span>
                                    <span class="status-text" id="statusText">Not connected</span>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="button" id="testAgentBtn" class="btn btn-secondary"
                                    title="Test DirectLine connection">Test Connection</button>
                                <button type="button" id="saveAgentBtn" class="btn btn-primary"
                                    title="Save agent configuration">Save Agent</button>
                            </div>
                        </div>

                        <!-- Current Active Agent Display -->
                        <div class="form-group">
                            <label>Currently Active Agent:</label>
                            <div class="current-agent-display" id="currentAgentDisplay">
                                <span id="currentAgentName">No agent selected</span>
                                <span class="agent-status disconnected" id="currentAgentStatus">Disconnected</span>
                            </div>
                        </div>

                        <!-- Streaming Options - moved here -->
                        <div class="form-group">
                            <label>Agent Options:</label>
                            <div class="feature-options">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="enableStreamingCheckbox" />
                                    <span class="checkmark"></span>
                                    Enable streaming responses (simulation mode)
                                </label>
                                <small class="help-text">Simulates progressive response display for better UX</small>

                                <label class="checkbox-label">
                                    <input type="checkbox" id="enableSideBrowserCheckbox" />
                                    <span class="checkmark"></span>
                                    Open citations in side browser
                                </label>
                                <small class="help-text">View citation sources within the app instead of external
                                    browser</small>

                                <label class="checkbox-label">
                                    <input type="checkbox" id="fullWidthMessagesCheckbox" />
                                    <span class="checkmark"></span>
                                    Display agent messages in full width
                                </label>
                                <small class="help-text">Show agent responses across the full panel width for maximum
                                    information display</small>
                            </div>
                        </div>

                        <!-- Speech Settings -->
                        <div class="form-group">
                            <label>Speech Settings:</label>

                            <!-- Speech Behavior Group -->
                            <div class="speech-behavior-group">
                                <h4 class="sub-section-title">‚öôÔ∏è Speech Behavior</h4>

                                <div class="feature-options">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="speechAutoSpeak" />
                                        <span class="checkmark"></span>
                                        Auto-speak agent messages when they arrive
                                    </label>
                                    <small class="help-text">Automatically read agent responses aloud using
                                        text-to-speech</small>

                                    <label class="checkbox-label">
                                        <input type="checkbox" id="speechVoiceInput" />
                                        <span class="checkmark"></span>
                                        Enable voice input (microphone)
                                    </label>
                                    <small class="help-text">Allow sending messages using voice commands</small>
                                </div>
                            </div>

                            <!-- Speech Provider & Voice Selection Group -->
                            <div class="speech-provider-group">
                                <h4 class="sub-section-title">üé§ Voice & Provider</h4>

                                <!-- Speech Provider Selection -->
                                <div class="form-row">
                                    <label for="speechProvider">Speech Provider:</label>
                                    <select id="speechProvider" class="speech-select">
                                        <option value="web_speech">Enhanced Web Speech API (Recommended)</option>
                                        <option value="local_ai">Local AI Models (Offline)</option>
                                        <option value="azure">Azure Speech Services (Premium)</option>
                                    </select>
                                </div>
                                <small class="help-text">
                                    <strong>Enhanced Web Speech API:</strong> Instant, reliable, high-quality voices
                                    (Recommended)<br>
                                    <strong>Local AI Models:</strong> Offline neural voices with 5 personality options
                                    (30-60s loading)<br>
                                    <strong>Azure Speech Services:</strong> Premium neural voices with highest
                                    naturalness (Requires subscription)
                                </small>

                                <!-- Voice Selection -->
                                <div class="form-row">
                                    <label for="speechVoiceSelect">Voice:</label>
                                    <select id="speechVoiceSelect" class="speech-select">
                                        <option value="">Loading voices...</option>
                                    </select>
                                </div>
                                <small class="help-text">
                                    <strong>Web Speech API:</strong> System voices (varies by OS/browser)<br>
                                    <strong>Local AI:</strong> Neutral ‚Ä¢ Warm ‚Ä¢ Confident ‚Ä¢ Gentle ‚Ä¢ Energetic<br>
                                    <strong>Azure:</strong> Premium neural voices with regional accents
                                </small>

                                <!-- Test Speech Button -->
                                <div class="form-row">
                                    <button type="button" id="testSpeechBtn" class="btn btn-small btn-secondary">
                                        üîä Test Voice
                                    </button>
                                </div>

                                <!-- Azure Settings (shown when Azure provider is selected) -->
                                <div id="azureSpeechSettings" class="azure-settings" style="display: none;">
                                    <h4>Azure Speech Services Configuration</h4>
                                    <p class="config-note">
                                        <strong>Note:</strong> Azure Speech Services requires a valid subscription key
                                        and region.
                                        <a href="https://portal.azure.com/#create/Microsoft.CognitiveServicesSpeechServices"
                                            target="_blank">Create an Azure Speech resource</a>
                                        to get your subscription key.
                                    </p>
                                    <div class="form-row">
                                        <label for="azureSubscriptionKey">Subscription Key: <span
                                                class="required">*</span></label>
                                        <input type="password" id="azureSubscriptionKey"
                                            placeholder="Enter Azure Speech subscription key" class="form-input"
                                            required>
                                    </div>
                                    <div class="form-row">
                                        <label for="azureRegion">Region:</label>
                                        <select id="azureRegion" class="speech-select">
                                            <option value="eastus">East US</option>
                                            <option value="westus">West US</option>
                                            <option value="westus2">West US 2</option>
                                            <option value="eastus2">East US 2</option>
                                            <option value="centralus">Central US</option>
                                            <option value="northcentralus">North Central US</option>
                                            <option value="southcentralus">South Central US</option>
                                            <option value="westcentralus">West Central US</option>
                                            <option value="canadacentral">Canada Central</option>
                                            <option value="brazilsouth">Brazil South</option>
                                            <option value="northeurope">North Europe</option>
                                            <option value="westeurope">West Europe</option>
                                            <option value="francecentral">France Central</option>
                                            <option value="germanywestcentral">Germany West Central</option>
                                            <option value="uksouth">UK South</option>
                                            <option value="switzerlandnorth">Switzerland North</option>
                                            <option value="uaenorth">UAE North</option>
                                            <option value="southafricanorth">South Africa North</option>
                                            <option value="centralindia">Central India</option>
                                            <option value="eastasia">East Asia</option>
                                            <option value="southeastasia">Southeast Asia</option>
                                            <option value="japaneast">Japan East</option>
                                            <option value="japanwest">Japan West</option>
                                            <option value="koreacentral">Korea Central</option>
                                            <option value="australiaeast">Australia East</option>
                                        </select>
                                    </div>
                                    <div class="form-row">
                                        <label for="azureVoiceName">Azure Voice:</label>
                                        <select id="azureVoiceName" class="speech-select">
                                            <option value="en-US-JennyNeural">Jenny (US Female)</option>
                                            <option value="en-US-AriaNeural">Aria (US Female)</option>
                                            <option value="en-US-GuyNeural">Guy (US Male)</option>
                                            <option value="en-US-DavisNeural">Davis (US Male)</option>
                                            <option value="en-GB-SoniaNeural">Sonia (UK Female)</option>
                                            <option value="en-GB-RyanNeural">Ryan (UK Male)</option>
                                            <option value="en-AU-NatashaNeural">Natasha (AU Female)</option>
                                            <option value="en-AU-WilliamNeural">William (AU Male)</option>
                                        </select>
                                    </div>
                                    <small class="help-text">Azure Speech Services provides premium neural voices with
                                        high naturalness</small>
                                </div>
                            </div>

                            <!-- Multi-Language Settings Group -->
                            <div class="multi-language-group">
                                <h4 class="sub-section-title">üåç Multi-Language Support</h4>

                                <div class="feature-options">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="autoDetectLanguage" />
                                        <span class="checkmark"></span>
                                        Auto-detect language and switch voice
                                    </label>
                                    <small class="help-text">Automatically detect the language of text and select
                                        appropriate voice for TTS</small>

                                    <label class="checkbox-label">
                                        <input type="checkbox" id="enableLanguageDetection" />
                                        <span class="checkmark"></span>
                                        Enable speech language identification
                                    </label>
                                    <small class="help-text">Automatically identify the language of spoken input (Azure
                                        Speech only)</small>

                                    <label class="checkbox-label">
                                        <input type="checkbox" id="continuousLanguageDetection" />
                                        <span class="checkmark"></span>
                                        Continuous language detection
                                    </label>
                                    <small class="help-text">Continuously identify language during speech recognition
                                        (may impact performance)</small>
                                </div>

                                <!-- Language Candidates Selection -->
                                <div class="form-row">
                                    <label for="candidateLanguages">Expected Languages:</label>
                                    <select id="candidateLanguages" multiple class="speech-select multi-select"
                                        size="6">
                                        <option value="en-US" selected>English (US)</option>
                                        <option value="en-GB">English (UK)</option>
                                        <option value="es-ES">Spanish (Spain)</option>
                                        <option value="es-MX">Spanish (Mexico)</option>
                                        <option value="fr-FR">French</option>
                                        <option value="de-DE">German</option>
                                        <option value="zh-CN">Chinese (Simplified)</option>
                                        <option value="zh-TW">Chinese (Traditional)</option>
                                        <option value="ja-JP">Japanese</option>
                                        <option value="ko-KR">Korean</option>
                                        <option value="ru-RU">Russian</option>
                                        <option value="ar-SA">Arabic</option>
                                        <option value="hi-IN">Hindi</option>
                                        <option value="pt-BR">Portuguese (Brazil)</option>
                                        <option value="it-IT">Italian</option>
                                        <option value="nl-NL">Dutch</option>
                                    </select>
                                </div>
                                <small class="help-text">
                                    Hold Ctrl/Cmd to select multiple languages. This improves accuracy for speech
                                    recognition
                                    and provides better voice matching for text-to-speech.
                                </small>
                            </div>

                            <!-- Speech Controls Group -->
                            <div class="speech-controls">
                                <h4 class="sub-section-title">üéõÔ∏è Voice Controls</h4>

                                <!-- Speech Rate -->
                                <div class="form-row">
                                    <label for="speechRate">Speaking Rate:</label>
                                    <div class="slider-container">
                                        <input type="range" id="speechRate" min="0.5" max="2" step="0.1" value="1"
                                            class="speech-slider">
                                        <span class="slider-value" id="speechRateValue">1.0x</span>
                                    </div>
                                </div>

                                <!-- Speech Volume -->
                                <div class="form-row">
                                    <label for="speechVolume">Volume:</label>
                                    <div class="slider-container">
                                        <input type="range" id="speechVolume" min="0" max="100" step="5" value="100"
                                            class="speech-slider">
                                        <span class="slider-value" id="speechVolumeValue">100%</span>
                                    </div>
                                </div>

                                <!-- Naturalness Setting -->
                                <div class="form-row">
                                    <label for="speechNaturalness">Naturalness:</label>
                                    <div class="slider-container">
                                        <input type="range" id="speechNaturalness" min="0" max="100" step="10"
                                            value="80" class="speech-slider">
                                        <span class="slider-value" id="speechNaturalnessValue">80%</span>
                                    </div>
                                </div>
                                <small class="help-text">Higher values provide more natural speech but may be
                                    slower</small>
                            </div>
                        </div>
                    </div>

                    <!-- AI Companion Section -->
                    <div id="ai-companion-section" class="settings-section">
                        <h3 class="section-title">AI Companion</h3>

                        <!-- AI Companion Enable/Disable -->
                        <div class="form-group">
                            <label>AI Companion Settings:</label>
                            <div class="feature-options">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="enableLLMCheckbox" />
                                    <span class="checkmark"></span>
                                    Enable AI Companion (requires API key or local Ollama)
                                </label>
                                <small class="help-text">AI assistant for conversation analysis and insights</small>
                            </div>
                        </div>

                        <!-- API Configuration Section -->
                        <div id="apiKeySection" style="display: none;">
                            <div class="form-group">
                                <label for="apiProviderSelect">AI Provider:</label>
                                <select id="apiProviderSelect" aria-describedby="providerHelp">
                                    <option value="openai">OpenAI GPT</option>
                                    <option value="anthropic">Anthropic Claude</option>
                                    <option value="azure">Azure OpenAI</option>
                                    <option value="ollama">Local Ollama</option>
                                </select>
                                <small id="providerHelp" class="help-text">Choose your preferred AI provider</small>
                            </div>

                            <!-- API Key Field -->
                            <div id="apiKeyField" class="form-group">
                                <label for="apiKeyInput">API Key:</label>
                                <input type="password" id="apiKeyInput" placeholder="Enter your API key..."
                                    aria-describedby="apiKeyHelp" />
                                <small id="apiKeyHelp" class="help-text">API key for the selected provider</small>
                            </div>

                            <!-- Azure OpenAI Configuration -->
                            <div id="azureConfig" style="display: none;">
                                <div class="form-group">
                                    <label for="azureEndpointInput">Azure Endpoint:</label>
                                    <input type="url" id="azureEndpointInput"
                                        placeholder="https://your-resource.openai.azure.com"
                                        aria-describedby="azureEndpointHelp" />
                                    <small id="azureEndpointHelp" class="help-text">Azure OpenAI service endpoint
                                        URL</small>
                                </div>

                                <div class="form-group">
                                    <label for="azureDeploymentInput">Deployment Name:</label>
                                    <input type="text" id="azureDeploymentInput" placeholder="gpt-4o-mini"
                                        aria-describedby="azureDeploymentHelp" />
                                    <small id="azureDeploymentHelp" class="help-text">Azure OpenAI deployment model
                                        name</small>
                                </div>

                                <div class="form-group">
                                    <label for="azureApiVersionInput">API Version:</label>
                                    <input type="text" id="azureApiVersionInput" placeholder="2024-02-01"
                                        value="2024-02-01" aria-describedby="azureApiVersionHelp" />
                                    <small id="azureApiVersionHelp" class="help-text">Azure OpenAI API version</small>
                                </div>

                                <div class="form-group">
                                    <button type="button" id="testAzureBtn" class="btn btn-secondary">
                                        Test Azure OpenAI Connection
                                    </button>
                                </div>
                            </div>

                            <!-- General API Test Button -->
                            <div id="apiTestSection" style="display: none;">
                                <div class="form-group">
                                    <button type="button" id="testApiBtn" class="btn btn-secondary">
                                        Test API Connection
                                    </button>
                                </div>
                            </div>

                            <!-- Ollama Configuration -->
                            <div id="ollamaConfig" style="display: none;">
                                <div class="form-group">
                                    <label for="ollamaUrlInput">Ollama Server URL:</label>
                                    <input type="url" id="ollamaUrlInput" placeholder="http://localhost:11434"
                                        value="http://localhost:11434" aria-describedby="ollamaUrlHelp" />
                                    <small id="ollamaUrlHelp" class="help-text">URL of your local Ollama server</small>
                                </div>

                                <div class="form-group">
                                    <label for="ollamaModelSelect">Available Models:</label>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <select id="ollamaModelSelect" style="flex: 1;" aria-describedby="modelHelp">
                                            <option value="">Select a model...</option>
                                        </select>
                                        <button type="button" id="refreshModelsBtn" class="btn btn-secondary btn-small">
                                            Refresh Models
                                        </button>
                                    </div>
                                    <small id="modelHelp" class="help-text">Models available on your Ollama
                                        server</small>
                                </div>

                                <div class="form-group">
                                    <button type="button" id="testOllamaBtn" class="btn btn-secondary">
                                        Test Ollama Connection
                                    </button>
                                </div>

                                <!-- Hidden field for backward compatibility -->
                                <input type="hidden" id="ollamaModelInput" />
                            </div>
                        </div>

                        <!-- Model Comparison View -->
                        <div class="form-group">
                            <label style="margin-bottom: 10px;">Token Usage Across Models:</label>
                            <div class="model-comparison-container">
                                <div class="model-comparison-header">
                                    <button type="button" id="refreshModelComparisonBtn"
                                        class="btn btn-small btn-secondary">
                                        Refresh Data
                                    </button>
                                    <button type="button" id="resetAllModelsBtn" class="btn btn-small btn-danger"
                                        style="margin-left: 8px;">
                                        Reset All Models
                                    </button>
                                </div>
                                <div id="modelComparisonTable" class="model-comparison-table">
                                    <!-- Dynamic content will be populated here -->
                                </div>
                            </div>
                            <small class="help-text">Compare token efficiency across different AI models you've
                                used</small>
                        </div>

                        <!-- Prompt Management Section -->
                        <div class="form-group">
                            <label style="margin-bottom: 10px;">AI Companion Prompt Management:</label>
                            <div class="prompt-management-section">
                                <div class="prompt-management-header">
                                    <p style="margin: 0 0 10px 0; color: #666; font-size: 14px;">
                                        Customize how the AI companion thinks and responds. Changes are saved
                                        automatically and only affect your experience.
                                    </p>
                                    <button type="button" id="managePromptsBtn" class="btn btn-secondary"
                                        style="font-size: 14px; padding: 10px 16px; min-width: 180px;">
                                        üé® Manage AI Prompts
                                    </button>
                                </div>
                            </div>
                            <small class="help-text">Review and customize AI companion thinking prompts, KPI
                                explanations, and response generation templates</small>
                        </div>
                    </div>

                    <!-- Appearance Section -->
                    <div id="appearance-section" class="settings-section">
                        <h3 class="section-title">Appearance</h3>

                        <!-- Message Icon Toggle -->
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="messageIconToggle" checked />
                                <span class="checkmark"></span>
                                Show message icons
                            </label>
                            <small class="help-text">Display user and agent avatars next to messages</small>
                        </div>

                        <!-- User Icon Selection -->
                        <div class="form-group" id="userIconGroup">
                            <label>User Icon:</label>
                            <div class="user-icon-selection">
                                <div class="current-icon-preview">
                                    <div class="icon-preview" id="currentUserIconPreview">
                                        <!-- Current selected icon will be shown here -->
                                    </div>
                                    <span class="current-icon-label">Current Icon</span>
                                </div>
                                <div class="icon-options">
                                    <div class="icon-option" data-icon="friendly">
                                        <div class="icon-preview friendly-avatar"></div>
                                        <span class="icon-name">Friendly</span>
                                    </div>
                                    <div class="icon-option" data-icon="robot">
                                        <div class="icon-preview robot-avatar"></div>
                                        <span class="icon-name">Robot</span>
                                    </div>
                                    <div class="icon-option" data-icon="assistant">
                                        <div class="icon-preview assistant-avatar"></div>
                                        <span class="icon-name">Assistant</span>
                                    </div>
                                    <div class="icon-option" data-icon="smart">
                                        <div class="icon-preview smart-avatar"></div>
                                        <span class="icon-name">Smart</span>
                                    </div>
                                    <div class="icon-option" data-icon="modern">
                                        <div class="icon-preview modern-avatar"></div>
                                        <span class="icon-name">Modern</span>
                                    </div>
                                    <div class="icon-option" data-icon="cute">
                                        <div class="icon-preview cute-avatar"></div>
                                        <span class="icon-name">Cute</span>
                                    </div>
                                    <div class="icon-option" data-icon="professional">
                                        <div class="icon-preview professional-avatar"></div>
                                        <span class="icon-name">Professional</span>
                                    </div>
                                    <div class="icon-option" data-icon="gaming">
                                        <div class="icon-preview gaming-avatar"></div>
                                        <span class="icon-name">Gaming</span>
                                    </div>
                                    <div class="icon-option" data-icon="minimal">
                                        <div class="icon-preview minimal-avatar"></div>
                                        <span class="icon-name">Minimal</span>
                                    </div>
                                    <div class="icon-option" data-icon="carter">
                                        <div class="icon-preview carter-avatar"></div>
                                        <span class="icon-name">Carter</span>
                                    </div>
                                    <div class="icon-option" data-icon="custom">
                                        <div class="icon-preview custom-icon" data-icon="document">
                                            <input type="file" id="customIconInput" accept="image/*"
                                                style="display: none;">
                                            <!-- Icon will be populated by main.js unified icon system -->
                                        </div>
                                        <span class="icon-name">Custom</span>
                                    </div>
                                </div>
                                <small class="help-text">Choose an icon to represent yourself in conversations</small>
                            </div>
                        </div>

                        <!-- Color Theme Selection -->
                        <div class="form-group">
                            <label for="colorThemeSelection">
                                Color Theme:
                            </label>
                            <div class="color-theme-gallery">
                                <div class="current-theme-preview">
                                    <div class="theme-preview-card" id="currentThemePreview">
                                        <div class="theme-gradient default-theme"></div>
                                        <span class="theme-name">Default</span>
                                    </div>
                                </div>
                                <div class="theme-options">
                                    <div class="theme-option" data-theme="default">
                                        <div class="theme-preview-card">
                                            <div class="theme-gradient default-theme"></div>
                                            <span class="theme-name">Default</span>
                                        </div>
                                    </div>
                                    <div class="theme-option" data-theme="ocean">
                                        <div class="theme-preview-card">
                                            <div class="theme-gradient ocean-theme"></div>
                                            <span class="theme-name">Ocean</span>
                                        </div>
                                    </div>
                                    <div class="theme-option" data-theme="sunset">
                                        <div class="theme-preview-card">
                                            <div class="theme-gradient sunset-theme"></div>
                                            <span class="theme-name">Sunset</span>
                                        </div>
                                    </div>
                                    <div class="theme-option" data-theme="forest">
                                        <div class="theme-preview-card">
                                            <div class="theme-gradient forest-theme"></div>
                                            <span class="theme-name">Forest</span>
                                        </div>
                                    </div>
                                    <div class="theme-option" data-theme="cosmic">
                                        <div class="theme-preview-card">
                                            <div class="theme-gradient cosmic-theme"></div>
                                            <span class="theme-name">Cosmic</span>
                                        </div>
                                    </div>
                                    <div class="theme-option" data-theme="aurora">
                                        <div class="theme-preview-card">
                                            <div class="theme-gradient aurora-theme"></div>
                                            <span class="theme-name">Aurora</span>
                                        </div>
                                    </div>
                                    <div class="theme-option" data-theme="minimal">
                                        <div class="theme-preview-card">
                                            <div class="theme-gradient minimal-theme"></div>
                                            <span class="theme-name">Minimal</span>
                                        </div>
                                    </div>
                                    <div class="theme-option" data-theme="dark">
                                        <div class="theme-preview-card">
                                            <div class="theme-gradient dark-theme"></div>
                                            <span class="theme-name">Dark</span>
                                        </div>
                                    </div>
                                </div>
                                <small class="help-text">Choose a background color theme for the chat interface</small>
                            </div>
                        </div>

                        <!-- Font Size Configuration - moved to bottom -->
                        <div class="form-group">
                            <label>Font Size Settings:</label>
                            <div class="font-size-config">
                                <!-- Agent Chat Font Size -->
                                <div class="font-size-setting">
                                    <label for="agentFontSize">Agent Chat Font Size:</label>
                                    <div style="display: flex; align-items: center; gap: 8px; margin-top: 5px;">
                                        <input type="range" id="agentFontSize" min="10" max="20" value="15" step="1"
                                            style="flex: 1;" aria-describedby="agentFontHelp" />
                                        <span id="agentFontSizeValue" class="font-size-value">15px</span>
                                    </div>
                                    <small id="agentFontHelp" class="help-text">Adjust font size for agent conversation
                                        messages</small>
                                </div>

                                <!-- AI Companion Font Size -->
                                <div class="font-size-setting" style="margin-top: 12px;">
                                    <label for="companionFontSize">AI Companion Font Size:</label>
                                    <div style="display: flex; align-items: center; gap: 8px; margin-top: 5px;">
                                        <input type="range" id="companionFontSize" min="8" max="16" value="12" step="1"
                                            style="flex: 1;" aria-describedby="companionFontHelp" />
                                        <span id="companionFontSizeValue" class="font-size-value">12px</span>
                                    </div>
                                    <small id="companionFontHelp" class="help-text">Adjust font size for AI companion
                                        messages</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Old loading indicator removed - now using unified notification system -->

    <!-- Side Browser for Citations -->
    <div id="sideBrowser" class="side-browser">
        <div class="side-browser-header">
            <h3 id="sideBrowserTitle">Citation Source</h3>
            <button id="closeSideBrowser" class="side-browser-close" title="Close browser">√ó</button>
        </div>
        <div id="sideBrowserContent" class="side-browser-content">
            <iframe id="sideBrowserFrame" src="about:blank" title="Citation content"></iframe>
            <div id="sideBrowserLoader" class="side-browser-loader">
                <div class="loader-spinner"></div>
                <p>Loading citation source...</p>
            </div>
            <div id="sideBrowserError" class="side-browser-error" style="display: none;">
                <p>Unable to load citation source. This content may be blocked by security policies.</p>
                <button id="openExternalBtn" class="btn btn-secondary">Open in External Browser</button>
            </div>
        </div>
    </div>

    <!-- Old logging panel removed - now using unified notification system -->

    <!-- Side Command Bar - Vertical Activity Bar -->
    <div id="sideCommandBar">
        <!-- Primary functions - top aligned -->
        <button id="conversationsButton" class="side-command-btn" title="Conversations"
            aria-label="Toggle conversations panel" data-icon="newChat">
            <!-- Icon will be populated by main.js unified icon system -->
        </button>

        <!-- Secondary functions - bottom aligned -->
        <button id="documentationButton" class="side-command-btn" title="Documentation" aria-label="View Documentation">
            <!-- Icon will be populated by main.js unified icon system -->
        </button>
        <button id="knowledgeHubButton" class="side-command-btn" title="Knowledge Hub" aria-label="Knowledge Hub">
            <!-- Icon will be populated by main.js unified icon system -->
        </button>
        <!-- Logging button removed - using unified notification system -->
        <button id="settingsButton" class="side-command-btn" title="Settings" aria-label="Settings">
            <!-- Icon will be populated by main.js unified icon system -->
        </button>
    </div> <!-- Screen Reader Only Content -->
    <div class="sr-only">
        <div id="liveRegion" aria-live="polite" aria-atomic="false"></div>
    </div>

    <!-- Application Scripts -->
    <script type="module" src="src/main.js"></script>
</body>

</html>